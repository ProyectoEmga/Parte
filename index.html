<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Parte EMGA 2025</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Html2Canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --navy: #003366;
            --gold: #cb9e03;
            --red-alert: #dc2626;
            --green-safe: #16a34a;
            --gray-neutral: #9ca3af;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 80px;
        }

        .header-bg {
            background: linear-gradient(135deg, var(--navy) 0%, #001f3f 100%);
            border-bottom: 4px solid var(--gold);
        }

        /* --- SWITCH PERSONALIZADO --- */
        .switch-container {
            width: 130px;
            height: 32px;
            border-radius: 999px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            display: flex;
            align-items: center;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            user-select: none;
        }

        .switch-thumb {
            width: 24px;
            height: 24px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 2;
        }

        .switch-label {
            width: 100%;
            text-align: center;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            z-index: 1;
            padding: 0 10px;
            transition: opacity 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* NEUTRO */
        .sw-neutral { background-color: #e5e7eb; border: 1px solid #d1d5db; color: #9ca3af; }
        .sw-neutral .switch-thumb { left: 4px; }
        .sw-neutral .switch-label { padding-left: 28px; }

        /* ACTIVO (Verde) */
        .sw-active { background-color: var(--green-safe); border: 1px solid var(--green-safe); color: white; }
        .sw-active .switch-thumb { left: calc(100% - 28px); }
        .sw-active .switch-label { padding-right: 28px; }

        /* ALERTA (Rojo) */
        .sw-alert { background-color: var(--red-alert); border: 1px solid var(--red-alert); color: white; }
        .sw-alert .switch-thumb { left: calc(100% - 28px); }
        .sw-alert .switch-label { padding-right: 28px; }

        .switch-container:active { transform: scale(0.96); }

        /* MODAL */
        .modal-overlay {
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(3px);
            animation: fadeIn 0.2s ease-out;
        }
        .modal-content { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* RESUMEN */
        .summary-section {
            background-color: white;
            border: 2px solid var(--navy);
            margin-top: 40px;
            position: relative;
        }
        .summary-header {
            background-color: var(--navy);
            color: white;
            text-align: center;
            font-weight: bold;
            text-transform: uppercase;
            padding: 10px;
            font-size: 1.1rem;
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stat-card { text-align: center; padding: 15px; border-right: 1px solid #eee; }
        .stat-card:last-child { border-right: none; }
        .stat-label { font-size: 0.65rem; font-weight: bold; color: #666; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .stat-value { font-size: 1.8rem; font-weight: 800; line-height: 1; }

        .detail-row { border-bottom: 1px dotted #e5e7eb; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .detail-category-header { background-color: #f9fafb; color: var(--red-alert); font-weight: bold; font-size: 0.8rem; text-transform: uppercase; padding: 6px 15px; border-left: 4px solid var(--red-alert); margin-top: 10px; }
        
        /* Botón Eliminar Discreto */
        .btn-trash {
            color: #d1d5db;
            transition: color 0.2s;
            padding: 8px;
        }
        .btn-trash:hover {
            color: var(--red-alert);
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header Fijo -->
    <nav class="header-bg text-white px-4 py-3 shadow-lg sticky top-0 z-20">
        <div class="flex justify-between items-center max-w-4xl mx-auto">
            <div>
                <h1 class="font-bold text-lg leading-none uppercase tracking-wide">Parte EMGA</h1>
                <p class="text-[10px] text-yellow-400 opacity-90 tracking-wider">Finanzas y Abastecimiento 2025</p>
            </div>
            <div id="save-indicator" class="text-xs text-green-400 font-bold opacity-0 transition-opacity duration-500">
                <i class="fas fa-save"></i> Guardado
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <main class="max-w-4xl mx-auto p-4 space-y-5">
        
        <!-- Barra Info -->
        <div class="bg-white rounded-lg shadow-sm p-3 flex justify-between items-center text-sm border-l-4 border-blue-900">
            <span class="text-gray-500 text-xs uppercase font-bold"><i class="far fa-clock mr-1"></i> <span id="last-updated">--:--</span></span>
            <span class="font-bold text-blue-900 bg-blue-50 px-3 py-1 rounded-full text-xs" id="total-count-display">DOTACIÓN: 0</span>
        </div>

        <!-- Lista de Personal -->
        <div id="personnel-list" class="space-y-4">
            <!-- Dinámico -->
        </div>

        <!-- Agregar Personal -->
        <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200 mt-6">
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-3 tracking-widest">Gestión de Dotación</h3>
            <div class="flex flex-col gap-3">
                <select id="new-group" class="w-full bg-gray-50 border border-gray-300 text-gray-800 text-sm rounded-lg p-2.5 font-medium">
                    <option value="FINANZAS">FINANZAS</option>
                    <option value="MOVILIZACIÓN">MOVILIZACIÓN</option>
                    <option value="STAFF JEFMAYOR">STAFF JEFMAYOR</option>
                    <option value="STAFF SUBMAYOR">STAFF SUBMAYOR</option>
                </select>
                <div class="flex gap-2">
                    <input type="text" id="new-name" placeholder="GRADO INICIAL. APELLIDO" class="flex-1 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5 uppercase font-medium placeholder-gray-400">
                    <button onclick="addPerson()" class="bg-blue-900 text-white px-5 py-2 rounded-lg font-bold hover:bg-blue-800 transition shadow-md active:bg-blue-950">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- RESUMEN FINAL -->
        <div id="summary-container-id" class="summary-section rounded-lg overflow-hidden shadow-lg">
            <div class="summary-header">
                <span>Resumen General</span>
                <button onclick="downloadSummaryImage()" class="bg-yellow-500 hover:bg-yellow-600 text-blue-900 text-xs px-3 py-1.5 rounded font-bold shadow transition flex items-center gap-1 ml-auto border border-blue-900" data-html2canvas-ignore>
                    <i class="fas fa-camera"></i> <span class="hidden sm:inline">Capturar</span>
                </button>
            </div>
            
            <div class="bg-white">
                <div id="summary-date-header" class="hidden text-center text-sm text-gray-500 pt-2 uppercase font-bold tracking-widest">
                    EMGA 2025 - Finanzas y Abastecimiento
                </div>

                <div class="grid grid-cols-3 border-b border-gray-200">
                    <div class="stat-card">
                        <span class="stat-label">Fuerza Efectiva</span>
                        <span class="stat-value text-blue-900" id="res-fuerza">0</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Forman (A Bordo)</span>
                        <span class="stat-value text-green-600" id="res-forman">0</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Con Motivo</span>
                        <span class="stat-value text-red-600" id="res-motivo">0</span>
                    </div>
                </div>

                <div class="p-0 pb-4">
                    <div class="bg-gray-100 text-center py-2 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200">
                        Detalle del Personal con Motivo
                    </div>
                    <div id="summary-detail-list"></div>
                </div>
                
                <div id="summary-footer-img" class="hidden text-center text-[10px] text-gray-400 pb-2">
                    Generado automáticamente por Parte Digital EMGA
                </div>
            </div>
        </div>

        <div class="text-center text-xs text-gray-400 mt-8 mb-4">
            Dpto. Finanzas y Abastecimiento - EMGA 2025
        </div>

    </main>

    <!-- Modal Selección Motivo Rojo -->
    <div id="red-status-modal" class="fixed inset-0 z-50 hidden modal-overlay flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="modal-content bg-white w-full max-w-sm rounded-t-2xl sm:rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-4 bg-red-600 text-white flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-lg" id="modal-person-name">NOMBRE</h3>
                    <p class="text-xs opacity-90">Seleccione motivo de inasistencia</p>
                </div>
                <button onclick="closeModal()" class="text-white hover:text-gray-200 p-2"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="p-4 grid grid-cols-1 gap-2">
                <button onclick="setRedStatus('En trabajos', false)" class="flex items-center p-3 rounded-lg border border-red-100 bg-red-50 text-red-800 font-bold hover:bg-red-100 active:bg-red-200 transition">
                    <i class="fas fa-tools w-8 text-center text-red-600"></i> EN TRABAJOS
                </button>
                <button onclick="setRedStatus('Con permiso', false)" class="flex items-center p-3 rounded-lg border border-red-100 bg-red-50 text-red-800 font-bold hover:bg-red-100 active:bg-red-200 transition">
                    <i class="fas fa-home w-8 text-center text-red-600"></i> CON PERMISO
                </button>
                <div class="border-t my-1"></div>
                <button onclick="setRedStatus('En comisión', true)" class="flex items-center p-3 rounded-lg border border-red-100 bg-red-50 text-red-800 font-bold hover:bg-red-100 active:bg-red-200 transition">
                    <i class="fas fa-briefcase w-8 text-center text-red-600"></i> EN COMISIÓN <span class="text-xs ml-auto bg-red-200 text-red-800 px-2 py-0.5 rounded">Detalle</span>
                </button>
                <button onclick="setRedStatus('De baja', true)" class="flex items-center p-3 rounded-lg border border-red-100 bg-red-50 text-red-800 font-bold hover:bg-red-100 active:bg-red-200 transition">
                    <i class="fas fa-procedures w-8 text-center text-red-600"></i> DE BAJA <span class="text-xs ml-auto bg-red-200 text-red-800 px-2 py-0.5 rounded">Detalle</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        const GROUPS = ["FINANZAS", "MOVILIZACIÓN", "STAFF JEFMAYOR", "STAFF SUBMAYOR"];
        const INITIAL_DB = [
            { group: "FINANZAS", name: "T1 A. VARAS" },
            { group: "FINANZAS", name: "PAC R. DÍAZ" },
            { group: "FINANZAS", name: "SO G. CASTRO" },
            { group: "FINANZAS", name: "SO J. MUÑOZ" },
            { group: "FINANZAS", name: "S1 C. ALARCÓN" },
            { group: "FINANZAS", name: "S1 M. ERAZO" },
            { group: "FINANZAS", name: "S2 G. CLAVERÍA" },
            { group: "FINANZAS", name: "C1 F. PIETRANTONI" },
            { group: "FINANZAS", name: "C1 S. DONOSO" },
            { group: "MOVILIZACIÓN", name: "S1 J. ESPINOZA" },
            { group: "MOVILIZACIÓN", name: "S1 C. JIMÉNEZ" },
            { group: "MOVILIZACIÓN", name: "C1 J. MORAGA" },
            { group: "STAFF JEFMAYOR", name: "SO R. CARIPÁN" },
            { group: "STAFF JEFMAYOR", name: "SO A. ESPINOZA" },
            { group: "STAFF JEFMAYOR", name: "S2 J. RAIN" },
            { group: "STAFF SUBMAYOR", name: "S1 M. NAVARRETE" },
            { group: "STAFF SUBMAYOR", name: "S2 J. MONSALVE" }
        ];

        let personnel = [];
        let editingPersonId = null; 

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            render();
        });

        // --- Datos y Persistencia ---
        function loadData() {
            const stored = localStorage.getItem('emga_db_2025_final_v2'); 
            if (stored) {
                personnel = JSON.parse(stored);
            } else {
                personnel = INITIAL_DB.map(p => ({
                    id: Math.random().toString(36).substr(2, 9),
                    group: p.group,
                    name: p.name,
                    status: "",
                    detail: ""
                }));
            }
            updateTimestamp();
        }

        function saveData() {
            localStorage.setItem('emga_db_2025_final_v2', JSON.stringify(personnel));
            updateTimestamp();
            showSaveIndicator();
        }

        function updateTimestamp() {
            const now = new Date();
            const time = now.toLocaleTimeString('es-CL', {hour: '2-digit', minute:'2-digit'});
            document.getElementById('last-updated').innerText = time + " hrs";
        }

        function showSaveIndicator() {
            const el = document.getElementById('save-indicator');
            el.style.opacity = '1';
            setTimeout(() => { el.style.opacity = '0'; }, 1500);
        }

        // --- Lógica de Estado (Switch) ---
        function cycleStatus(id) {
            const person = personnel.find(p => p.id === id);
            if (!person) return;

            if (person.status === "") {
                // Gris -> Verde
                person.status = "A bordo";
                person.detail = ""; 
                saveData();
                render();
            } else if (person.status === "A bordo") {
                // Verde -> Rojo (Modal)
                openRedModal(id, person.name);
            } else {
                // Rojo -> Gris
                person.status = "";
                person.detail = "";
                saveData();
                render();
            }
        }

        function openRedModal(id, name) {
            editingPersonId = id;
            document.getElementById('modal-person-name').innerText = name;
            document.getElementById('red-status-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('red-status-modal').classList.add('hidden');
            editingPersonId = null;
        }

        function setRedStatus(status, requiresDetail) {
            if (editingPersonId) {
                const person = personnel.find(p => p.id === editingPersonId);
                if (person) {
                    let detail = "";
                    if (requiresDetail) {
                        let userInput = prompt(`Ingrese detalle para "${status.toUpperCase()}":`);
                        if (userInput === null) {
                            closeModal();
                            return; 
                        }
                        detail = userInput || ""; 
                    }
                    person.status = status;
                    person.detail = detail;
                    saveData();
                    render();
                }
            }
            closeModal();
        }

        // --- Agregar / Eliminar ---
        function addPerson() {
            const nameIn = document.getElementById('new-name');
            const groupIn = document.getElementById('new-group');
            const name = nameIn.value.trim().toUpperCase();
            if(!name) return alert("Ingrese un nombre");
            personnel.push({ id: Math.random().toString(36).substr(2, 9), group: groupIn.value, name: name, status: "", detail: "" });
            nameIn.value = '';
            saveData();
            render();
        }

        // Función de eliminación DIRECTA (vinculada al botón de papelera)
        function deletePerson(id) {
            if(confirm("¿Estás seguro de que quieres eliminar a esta persona de la lista permanentemente?")) {
                personnel = personnel.filter(p => p.id !== id);
                saveData();
                render();
            }
        }

        // --- Renderizado ---
        function render() {
            renderList();
            renderSummary();
        }

        function renderList() {
            const container = document.getElementById('personnel-list');
            container.innerHTML = '';
            document.getElementById('total-count-display').innerText = `DOTACIÓN: ${personnel.length}`;

            GROUPS.forEach(groupName => {
                const groupData = personnel.filter(p => p.group === groupName);
                if (groupData.length === 0) return;

                const groupCard = document.createElement('div');
                groupCard.className = 'bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden';
                
                groupCard.innerHTML = `
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-100 flex justify-between items-center">
                        <h2 class="text-xs font-bold text-blue-900 uppercase tracking-widest">${groupName}</h2>
                        <span class="text-[10px] bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full font-bold">${groupData.length}</span>
                    </div>
                `;

                const list = document.createElement('div');
                list.className = 'divide-y divide-gray-50';

                groupData.forEach(p => {
                    const row = document.createElement('div');
                    row.className = 'p-3 flex items-center justify-between hover:bg-gray-50 transition-colors';
                    
                    // Columna Nombre + Detalle
                    const nameCol = document.createElement('div');
                    nameCol.className = 'flex flex-col overflow-hidden mr-2 flex-1';
                    let nameHtml = `<span class="text-sm font-bold text-gray-700 truncate">${p.name}</span>`;
                    if(p.detail) {
                        nameHtml += `<span class="text-[10px] text-gray-500 italic truncate">${p.detail}</span>`;
                    }
                    nameCol.innerHTML = nameHtml;

                    // Contenedor de Controles (Trash + Switch)
                    const controls = document.createElement('div');
                    controls.className = 'flex items-center gap-2';

                    // Botón Eliminar Directo
                    const trashBtn = document.createElement('button');
                    trashBtn.className = 'btn-trash';
                    trashBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    trashBtn.onclick = (e) => {
                        e.stopPropagation(); // Evitar triggers
                        deletePerson(p.id);
                    };

                    // Switch
                    let switchClass = 'sw-neutral';
                    let switchText = 'SIN INFO';

                    if (p.status === 'A bordo') {
                        switchClass = 'sw-active';
                        switchText = 'A BORDO';
                    } else if (p.status !== '') {
                        switchClass = 'sw-alert';
                        switchText = p.status.toUpperCase();
                        if(switchText.length > 10) switchText = p.status.substr(0, 9) + '.';
                    }

                    const switchEl = document.createElement('div');
                    switchEl.className = `switch-container ${switchClass}`;
                    switchEl.innerHTML = `
                        <div class="switch-track"></div>
                        <div class="switch-thumb"></div>
                        <span class="switch-label">${switchText}</span>
                    `;
                    switchEl.onclick = () => cycleStatus(p.id);

                    controls.appendChild(trashBtn);
                    controls.appendChild(switchEl);

                    row.appendChild(nameCol);
                    row.appendChild(controls);
                    list.appendChild(row);
                });

                groupCard.appendChild(list);
                container.appendChild(groupCard);
            });
        }

        function renderSummary() {
            const fuerzaEfectiva = personnel.length;
            const forman = personnel.filter(p => p.status === "A bordo").length;
            const conMotivoList = personnel.filter(p => p.status !== "" && p.status !== "A bordo");
            const conMotivo = conMotivoList.length;

            document.getElementById('res-fuerza').innerText = fuerzaEfectiva;
            document.getElementById('res-forman').innerText = forman;
            document.getElementById('res-motivo').innerText = conMotivo;

            const detailContainer = document.getElementById('summary-detail-list');
            detailContainer.innerHTML = '';

            if (conMotivo === 0) {
                detailContainer.innerHTML = `<div class="p-6 text-center text-gray-400 text-sm italic">Sin personal con motivo.</div>`;
                return;
            }

            const motiveGroups = {};
            conMotivoList.forEach(p => {
                if(!motiveGroups[p.status]) motiveGroups[p.status] = [];
                motiveGroups[p.status].push(p);
            });

            const order = ["En trabajos", "En comisión", "De baja", "Con permiso"];
            const keys = order.filter(k => motiveGroups[k]).concat(
                Object.keys(motiveGroups).filter(k => !order.includes(k))
            );

            keys.forEach(status => {
                const catTitle = document.createElement('div');
                catTitle.className = 'detail-category-header';
                catTitle.innerText = status;
                detailContainer.appendChild(catTitle);

                motiveGroups[status].forEach(p => {
                    const row = document.createElement('div');
                    row.className = 'detail-row bg-white';
                    let detailTxt = p.detail ? `(${p.detail})` : "";
                    row.innerHTML = `
                        <span class="font-bold text-gray-800">${p.name}</span>
                        <span class="text-xs text-gray-500 italic text-right pl-2">${detailTxt}</span>
                    `;
                    detailContainer.appendChild(row);
                });
            });
        }

        function downloadSummaryImage() {
            const element = document.getElementById("summary-container-id");
            const now = new Date();
            
            const dateHeader = document.getElementById('summary-date-header');
            const footerImg = document.getElementById('summary-footer-img');
            dateHeader.innerText = `EMGA 2025 - ${now.toLocaleDateString('es-CL')}`;
            
            dateHeader.classList.remove('hidden');
            footerImg.classList.remove('hidden');

            html2canvas(element, { 
                scale: 2, 
                backgroundColor: "#ffffff"
            }).then(canvas => {
                dateHeader.classList.add('hidden');
                footerImg.classList.add('hidden');

                const link = document.createElement('a');
                link.download = `Resumen_EMGA_${now.getDate()}_${now.getMonth()+1}.jpg`;
                link.href = canvas.toDataURL("image/jpeg", 0.95);
                link.click();
            });
        }
    </script>
</body>
</html>

