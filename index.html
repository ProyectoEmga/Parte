<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parte Dpto. Finanzas y Abastecimiento EMGA 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 0;
        }
        .header-armada {
            background-color: #003366;
            color: #ffffff;
            padding: 1.5rem;
            text-align: center;
            border-bottom: 5px solid #ffcc00;
            position: relative;
        }
        .header-armada .last-updated {
            position: absolute;
            bottom: 0.5rem;
            right: 1rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }
        .container-armada {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-top: 2rem;
            width: 95%;
            max-width: 1024px;
            box-sizing: border-box;
        }
        @media (min-width: 768px) {
            .container-armada { width: 75%; }
        }
        @media (min-width: 1024px) {
            .container-armada { width: 66%; }
        }
        @media (min-width: 1280px) {
            .container-armada { width: 50%; }
        }

        /* Estilos para las tarjetas de personal */
        #personnel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* 140px min width */
            gap: 1rem;
            margin-top: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .person-card {
            background-color: #e0e7ff; /* Fondo azul claro */
            border: 1px solid #a7baff;
            border-radius: 0.5rem;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Empuja el estado hacia abajo */
            min-height: 90px; /* Altura mínima para las tarjetas */
        }
        .person-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .person-card-name {
            font-weight: bold;
            color: #003366;
            margin-bottom: 0.25rem;
            line-height: 1.2;
            flex-grow: 1; /* Permite que el nombre ocupe espacio */
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Limita el nombre a 2 líneas si es muy largo */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .person-card-status {
            font-size: 0.75rem;
            color: #4a5568;
            background-color: #c3daff; /* Fondo más claro para el estado */
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            margin-top: 0.5rem; /* Espacio arriba del estado */
            white-space: nowrap; /* Evita que el estado se rompa en varias líneas */
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .remove-card-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s, background-color 0.2s;
            line-height: 1; /* Asegura que la 'X' esté centrada */
            padding: 0;
        }
        .remove-card-btn:hover {
            opacity: 1;
            background-color: #c82333;
        }

        /* Estilos del Popover/Modal de edición */
        .popover-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .popover-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .popover-content {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            width: 350px;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            position: relative;
        }
        .popover-overlay.visible .popover-content {
            transform: translateY(0);
            opacity: 1;
        }
        .popover-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
        }
        .popover-close-btn:hover {
            color: #333;
        }
        .popover-content h4 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #003366;
            text-align: center;
        }
        .popover-content select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            font-size: 1rem;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3e%3cpath d='M7 7l3-3 3 3m0 6l-3 3-3-3' stroke='%234A5568' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em;
            accent-color: #003366;
        }
        .popover-content .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        .popover-content .button-group button {
            padding: 0.6rem 1.2rem;
            border-radius: 0.375rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }
        .popover-content .button-group .save-btn {
            background-color: #004080;
            color: white;
        }
        .popover-content .button-group .save-btn:hover {
            background-color: #0056b3;
        }
        .popover-content .button-group .cancel-btn {
            background-color: #e2e8f0;
            color: #4a5568;
        }
        .popover-content .button-group .cancel-btn:hover {
            background-color: #cbd5e0;
        }

        /* Estilos del resumen (modificaciones para estética) */
        .summary-box {
            background-color: #e6f0f9;
            border: 1px solid #b3d1f1;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
            text-align: center;
        }
        .summary-section {
            padding: 1rem; /* Aumentado padding para más espacio */
            border-bottom: 1px dotted #cce0f5;
            text-align: left;
        }
        .summary-section:last-of-type {
            border-bottom: none;
        }
        .summary-section h4 {
            margin-bottom: 1rem; /* Más espacio debajo del título de sección */
            text-align: center;
            font-size: 1.125rem; /* Ajuste para consistencia */
            color: #2d3748; /* Color un poco más oscuro */
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0; /* Aumentado padding vertical */
        }
        .summary-item span:first-child {
            font-weight: bold;
            color: #003366;
            flex-grow: 1; /* Permite que el texto del nombre ocupe más espacio */
        }
        .summary-item span:last-child {
            font-weight: bold;
            color: #003366;
            font-size: 1.1rem; /* Ligeramente más grande para los totales */
            min-width: 25px; /* Ancho mínimo para alinear números */
            text-align: right;
        }

        /* Estilos específicos para el desglose con dropdowns */
        .summary-item.with-dropdown {
            flex-direction: column;
            align-items: flex-start;
            padding: 0.75rem 0; /* Un poco más de padding */
        }
        .summary-item.with-dropdown > span:first-child {
            width: 100%;
            margin-bottom: 0.5rem;
            font-size: 1rem; /* Ajuste para el título del desglose */
            text-align: left; /* Alinea el título del desglose a la izquierda */
        }
        @media (min-width: 640px) {
            .summary-item.with-dropdown {
                flex-direction: row;
                align-items: flex-start;
            }
            .summary-item.with-dropdown > span:first-child {
                width: auto;
                margin-bottom: 0;
            }
        }
        .personnel-dropdown {
            font-size: 0.8rem; /* Ligeramente más grande para los nombres */
            color: #4a5568;
            margin-top: 0.5rem; /* Más espacio arriba del cuadro de nombres */
            padding: 0.75rem; /* Más padding interno */
            background-color: #f9fbfd;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            display: none;
            line-height: 1.5; /* Mayor espaciado entre líneas */
            max-height: 180px; /* Altura máxima ligeramente mayor */
            overflow-y: auto;
            flex-grow: 1;
        }
        .personnel-dropdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .personnel-dropdown li {
            padding: 0.15rem 0; /* Más espacio entre nombres */
            border-bottom: 1px dotted #ebf1f7; /* Borde sutil entre nombres */
        }
        .personnel-dropdown li:last-child {
            border-bottom: none;
        }
        .personnel-dropdown:empty {
            display: none;
        }
        .add-person-section {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }
        @media (min-width: 640px) {
            .add-person-section {
                flex-direction: row;
                align-items: center;
            }
        }
        .add-person-section input {
            flex-grow: 1;
            padding: 0.5rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.375rem;
            width: 100%;
        }
        .button-armada {
            background-color: #004080;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.375rem;
            font-weight: bold;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
            width: 100%;
        }
        @media (min-width: 640px) {
            .button-armada {
                width: auto;
            }
        }
        .button-armada:hover {
            background-color: #0056b3;
        }
        
        /* Ocultar elementos para la captura de imagen */
        .no-capture {
            display: none !important;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">
    <header class="header-armada w-full">
        <h1 class="text-3xl font-bold">Parte Dpto. Finanzas y Abastecimiento EMGA 2025</h1>
        <div class="last-updated" id="last-updated"></div>
    </header>

    <div class="container-armada mt-8 mb-8">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Estado del Personal</h2>

        <div id="personnel-grid">
            </div>

        <div class="add-person-section">
            <input type="text" id="new-person-name" placeholder="Ingrese nuevo nombre de persona">
            <button type="button" id="add-person-btn" class="button-armada">Agregar Persona</button>
        </div>

        <div class="summary-box" id="summary-box-to-capture">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Resumen General</h3>

            <div class="summary-section" id="summary-counts-display">
                <h4 class="text-lg font-semibold mb-2 text-gray-700">Cantidades por Categoría</h4>
                <div class="summary-item">
                    <span>Fuerza Efectiva:</span>
                    <span id="effective-force-count">0</span>
                </div>
                <div class="summary-item">
                    <span>Alto mando:</span>
                    <span id="altomando-count-num">0</span>
                </div>
                <div class="summary-item">
                    <span>A bordo:</span>
                    <span id="abordo-count-num">0</span>
                </div>
                <div class="summary-item">
                    <span>En trabajos:</span>
                    <span id="trabajos-count-num">0</span>
                </div>
                <div class="summary-item">
                    <span>En comisión:</span>
                    <span id="comision-count-num">0</span>
                </div>
                <div class="summary-item">
                    <span>De baja:</span>
                    <span id="baja-count-num">0</span>
                </div>
                <div class="summary-item">
                    <span>Con permiso:</span>
                    <span id="permiso-count-num">0</span>
                </div>
            </div>

            <div class="summary-section mt-6" id="summary-details-display">
                <h4 class="text-lg font-semibold mb-2 text-gray-700">Detalle por Categoría</h4>
                <div class="summary-item with-dropdown">
                    <span>Alto mando:</span>
                    <div class="personnel-dropdown" id="altomando-dropdown"></div>
                </div>
                <div class="summary-item with-dropdown">
                    <span>A bordo:</span>
                    <div class="personnel-dropdown" id="abordo-dropdown"></div>
                </div>
                <div class="summary-item with-dropdown">
                    <span>En trabajos:</span>
                    <div class="personnel-dropdown" id="trabajos-dropdown"></div>
                </div>
                <div class="summary-item with-dropdown">
                    <span>En comisión:</span>
                    <div class="personnel-dropdown" id="comision-dropdown"></div>
                </div>
                <div class="summary-item with-dropdown">
                    <span>De baja:</span>
                    <div class="personnel-dropdown" id="baja-dropdown"></div>
                </div>
                <div class="summary-item with-dropdown">
                    <span>Con permiso:</span>
                    <div class="personnel-dropdown" id="permiso-dropdown"></div>
                </div>
            </div>
        </div>
        <button type="button" id="download-summary-btn" class="button-armada mt-6 w-full bg-green-600 hover:bg-green-700">Descargar Resumen como Imagen</button>
    </div>

    <div class="popover-overlay" id="edit-status-popover">
        <div class="popover-content">
            <button class="popover-close-btn" id="popover-close-btn">&times;</button>
            <h4 id="popover-person-name"></h4>
            <select id="popover-status-select">
                <option value="">Seleccione estado</option>
            </select>
            <div class="button-group">
                <button class="save-btn" id="popover-save-btn">Guardar</button>
                <button class="cancel-btn" id="popover-cancel-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const personnelGrid = document.getElementById('personnel-grid');
            const addPersonBtn = document.getElementById('add-person-btn');
            const newPersonNameInput = document.getElementById('new-person-name');
            const lastUpdatedElement = document.getElementById('last-updated');
            const downloadSummaryBtn = document.getElementById('download-summary-btn');
            const summaryBoxToCapture = document.getElementById('summary-box-to-capture');

            const editStatusPopover = document.getElementById('edit-status-popover');
            const popoverCloseBtn = document.getElementById('popover-close-btn');
            const popoverCancelBtn = document.getElementById('popover-cancel-btn');
            const popoverSaveBtn = document.getElementById('popover-save-btn');
            const popoverPersonName = document.getElementById('popover-person-name');
            const popoverStatusSelect = document.getElementById('popover-status-select');

            const personnelDataKey = 'personnelDataEmga2025';
            const lastUpdatedKey = 'lastUpdatedEmga2025';

            let personnel = [];
            let currentEditingPersonId = null; // Para saber qué persona estamos editando

            const initialPersonnelNames = [
                'T1 ANDRÉS VARAS',
                'PAC RAÚL DÍAZ',
                'SO GERMÁN CASTRO',
                'SO JUAN MUÑOZ',
                'SO ALFONSO ESPINOZA',
                'S1 CARLOS ALARCÓN',
                'S1 JORGE ESPINOZA',
                'S1 CARLOS JIMÉNEZ',
                'S1 ROBERTO ALEGRIA',
                'S1 MARCOS ERAZO',
                'S1 GREGORY FUENTES',
                'S2 GABRIEL CLAVERÍA',
                'S2 JOSUÉ RAÍN',
                'C1 JONATAN MORAGA',
                'C1 SAMI DONOSO',
                'TT PEDRO VERDUGO'
            ];

            const categories = [
                { value: 'alto mando', text: 'Alto mando' },
                { value: 'a bordo', text: 'A bordo' },
                { value: 'en trabajos', text: 'En trabajos' },
                { value: 'en comisión', text: 'En comisión' },
                { value: 'de baja', text: 'De baja' },
                { value: 'con permiso', text: 'Con permiso' }
            ];

            // Rellenar el selector del popover con las categorías
            function populatePopoverCategories() {
                popoverStatusSelect.innerHTML = '<option value="">Seleccione estado</option>';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.value;
                    option.textContent = cat.text;
                    popoverStatusSelect.appendChild(option);
                });
            }

            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            }

            function savePersonnelData() {
                try {
                    localStorage.setItem(personnelDataKey, JSON.stringify(personnel));
                    updateLastUpdatedTime();
                } catch (error) {
                    console.warn('No se pudo guardar en localStorage:', error);
                }
            }

            function loadPersonnelData() {
                try {
                    const storedData = localStorage.getItem(personnelDataKey);
                    if (storedData) {
                        const loadedPersonnel = JSON.parse(storedData);
                        const loadedPersonnelMap = new Map(loadedPersonnel.map(p => [p.name, p]));

                        personnel = [];
                        initialPersonnelNames.forEach(name => {
                            if (loadedPersonnelMap.has(name)) {
                                personnel.push(loadedPersonnelMap.get(name));
                                loadedPersonnelMap.delete(name);
                            } else {
                                personnel.push({ id: generateId(), name: name, status: '' });
                            }
                        });

                        // Add any additional personnel that were not in the initial list
                        loadedPersonnel.forEach(p => {
                            if (!initialPersonnelNames.includes(p.name)) {
                                personnel.push(p);
                            }
                        });
                    } else {
                        personnel = initialPersonnelNames.map(name => ({
                            id: generateId(),
                            name: name,
                            status: ''
                        }));
                    }
                } catch (error) {
                    console.warn('Error al cargar datos:', error);
                    personnel = initialPersonnelNames.map(name => ({
                        id: generateId(),
                        name: name,
                        status: ''
                    }));
                }
                renderPersonnelGrid();
            }

            function updateLastUpdatedTime() {
                const now = new Date();
                const options = {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZoneName: 'short',
                    hour12: false
                };
                try {
                    const formattedDate = new Intl.DateTimeFormat('es-CL', {
                        ...options,
                        timeZone: 'America/Santiago'
                    }).format(now);
                    lastUpdatedElement.textContent = `Última actualización: ${formattedDate}`;
                    localStorage.setItem(lastUpdatedKey, formattedDate);
                } catch (error) {
                    console.warn('Error al actualizar tiempo:', error);
                    lastUpdatedElement.textContent = `Última actualización: ${now.toLocaleString()}`;
                }
            }

            function loadLastUpdatedTime() {
                try {
                    const storedTime = localStorage.getItem(lastUpdatedKey);
                    if (storedTime) {
                        lastUpdatedElement.textContent = `Última actualización: ${storedTime}`;
                    } else {
                        lastUpdatedElement.textContent = 'Última actualización: Nunca';
                    }
                } catch (error) {
                    console.warn('Error al cargar tiempo:', error);
                    lastUpdatedElement.textContent = 'Última actualización: Nunca';
                }
            }

            function createPersonCard(person) {
                const card = document.createElement('div');
                card.className = 'person-card';
                card.dataset.id = person.id; // Almacena el ID para fácil acceso

                // Botón de eliminar
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-card-btn';
                removeBtn.textContent = 'X';
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Evita que se abra el popover al hacer clic en eliminar
                    removePerson(person.id);
                });

                // Nombre de la persona
                const nameDiv = document.createElement('div');
                nameDiv.className = 'person-card-name';
                nameDiv.textContent = person.name;

                // Estado de la persona
                const statusDiv = document.createElement('div');
                statusDiv.className = 'person-card-status';
                statusDiv.textContent = categories.find(cat => cat.value === person.status)?.text || 'Sin estado';

                card.appendChild(removeBtn);
                card.appendChild(nameDiv);
                card.appendChild(statusDiv);

                // Evento para abrir el popover al hacer clic en la tarjeta
                card.addEventListener('click', () => openEditPopover(person));

                return card;
            }

            function renderPersonnelGrid() {
                personnelGrid.innerHTML = '';
                personnel.forEach(person => {
                    personnelGrid.appendChild(createPersonCard(person));
                });
                updateSummary();
            }

            function addPerson() {
                const name = newPersonNameInput.value.trim();
                if (name) {
                    if (personnel.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                        alert('Esta persona ya existe en la lista.');
                        return;
                    }

                    const newPerson = {
                        id: generateId(),
                        name: name,
                        status: ''
                    };
                    personnel.push(newPerson);
                    newPersonNameInput.value = '';
                    savePersonnelData();
                    renderPersonnelGrid();
                } else {
                    alert('Por favor, ingrese un nombre para la persona.');
                }
            }

            function removePerson(idToRemove) {
                if (confirm('¿Está seguro de que desea eliminar a esta persona?')) {
                    personnel = personnel.filter(person => person.id !== idToRemove);
                    savePersonnelData();
                    renderPersonnelGrid();
                }
            }

            function openEditPopover(person) {
                currentEditingPersonId = person.id;
                popoverPersonName.textContent = person.name;
                popoverStatusSelect.value = person.status;
                editStatusPopover.classList.add('visible');
            }

            function closeEditPopover() {
                editStatusPopover.classList.remove('visible');
                currentEditingPersonId = null;
            }

            function savePopoverChanges() {
                if (currentEditingPersonId) {
                    const personToUpdate = personnel.find(p => p.id === currentEditingPersonId);
                    if (personToUpdate) {
                        personToUpdate.status = popoverStatusSelect.value;
                        savePersonnelData();
                        renderPersonnelGrid(); // Volver a renderizar para actualizar la tarjeta
                    }
                }
                closeEditPopover();
            }

            function updateSummary() {
                const counts = {
                    'effectiveForce': personnel.length,
                    'alto mando': 0,
                    'a bordo': 0,
                    'en trabajos': 0,
                    'en comisión': 0,
                    'de baja': 0,
                    'con permiso': 0
                };

                const personnelByCategory = {
                    'alto mando': [],
                    'a bordo': [],
                    'en trabajos': [],
                    'en comisión': [],
                    'de baja': [],
                    'con permiso': []
                };

                personnel.forEach(person => {
                    if (categories.some(cat => cat.value === person.status)) {
                        counts[person.status]++;
                        personnelByCategory[person.status].push(person.name);
                    }
                });

                document.getElementById('effective-force-count').textContent = counts.effectiveForce;
                document.getElementById('altomando-count-num').textContent = counts['alto mando'];
                document.getElementById('abordo-count-num').textContent = counts['a bordo'];
                document.getElementById('trabajos-count-num').textContent = counts['en trabajos'];
                document.getElementById('comision-count-num').textContent = counts['en comisión'];
                document.getElementById('baja-count-num').textContent = counts['de baja'];
                document.getElementById('permiso-count-num').textContent = counts['con permiso'];

                const dropdownMappings = {
                    'alto mando': 'altomando-dropdown',
                    'a bordo': 'abordo-dropdown',
                    'en trabajos': 'trabajos-dropdown',
                    'en comisión': 'comision-dropdown',
                    'de baja': 'baja-dropdown',
                    'con permiso': 'permiso-dropdown'
                };

                Object.keys(dropdownMappings).forEach(category => {
                    const dropdown = document.getElementById(dropdownMappings[category]);
                    const names = personnelByCategory[category];

                    if (names.length > 0) {
                        dropdown.innerHTML = '<ul>' + names.map(name => `<li>${name}</li>`).join('') + '</ul>';
                        dropdown.style.display = 'block';
                    } else {
                        dropdown.innerHTML = '';
                        dropdown.style.display = 'none';
                    }
                });
            }

            function downloadSummaryAsImage() {
                // Elementos que deben ocultarse para la captura
                const elementsToHideForCapture = document.querySelectorAll('#personnel-grid, .add-person-section, #download-summary-btn, .header-armada');
                elementsToHideForCapture.forEach(el => el.classList.add('no-capture'));

                // Asegurarse de que todos los dropdowns estén visibles para la captura
                const dropdowns = document.querySelectorAll('.personnel-dropdown');
                dropdowns.forEach(dropdown => {
                    dropdown.style.display = 'block';
                    dropdown.style.maxHeight = 'none';
                    dropdown.style.overflow = 'visible';
                });

                html2canvas(summaryBoxToCapture, {
                    scale: 2,
                    logging: false,
                    useCORS: true
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Resumen_Personal_EMGA_${new Date().toLocaleDateString('es-CL').replace(/\//g, '-')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // Restaurar la visibilidad y propiedades de los elementos
                    elementsToHideForCapture.forEach(el => el.classList.remove('no-capture'));
                    dropdowns.forEach(dropdown => {
                        if (dropdown.innerHTML.trim() !== '') {
                            dropdown.style.display = 'block';
                        } else {
                            dropdown.style.display = 'none';
                        }
                        dropdown.style.maxHeight = '150px';
                        dropdown.style.overflowY = 'auto';
                    });
                }).catch(error => {
                    console.error('Error al generar la imagen del resumen:', error);
                    alert('Hubo un error al generar la imagen del resumen.');
                    // Asegurarse de restaurar la visibilidad incluso en caso de error
                    elementsToHideForCapture.forEach(el => el.classList.remove('no-capture'));
                    const dropdowns = document.querySelectorAll('.personnel-dropdown');
                    dropdowns.forEach(dropdown => {
                        if (dropdown.innerHTML.trim() !== '') {
                            dropdown.style.display = 'block';
                        } else {
                            dropdown.style.display = 'none';
                        }
                        dropdown.style.maxHeight = '150px';
                        dropdown.style.overflowY = 'auto';
                    });
                });
            }

            // Event listeners
            addPersonBtn.addEventListener('click', addPerson);
            newPersonNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addPerson();
                }
            });
            downloadSummaryBtn.addEventListener('click', downloadSummaryAsImage);

            // Popover event listeners
            popoverCloseBtn.addEventListener('click', closeEditPopover);
            popoverCancelBtn.addEventListener('click', closeEditPopover);
            popoverSaveBtn.addEventListener('click', savePopoverChanges);
            editStatusPopover.addEventListener('click', (e) => {
                // Cierra el popover si se hace clic fuera del contenido
                if (e.target === editStatusPopover) {
                    closeEditPopover();
                }
            });

            // Inicialización
            populatePopoverCategories(); // Rellenar categorías al cargar
            loadPersonnelData();
            loadLastUpdatedTime();
        });
    </script>
</body>
</html>
