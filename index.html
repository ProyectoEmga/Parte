<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parte Dpto. Finanzas y Abastecimiento EMGA 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 0;
        }
        .header-armada {
            background-color: #003366;
            color: #ffffff;
            padding: 1.5rem;
            text-align: center;
            border-bottom: 5px solid #ffcc00;
            position: relative;
        }
        .header-armada .last-updated {
            position: absolute;
            bottom: 0.5rem;
            right: 1rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }
        .container-armada {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-top: 2rem;
            width: 95%;
            max-width: 1024px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        @media (min-width: 768px) {
            .container-armada { width: 75%; }
        }
        @media (min-width: 1024px) {
            .container-armada { width: 66%; }
        }
        @media (min-width: 1280px) {
            .container-armada { width: 50%; }
        }

        /* Estilos para las tarjetas de personal */
        #personnel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* 140px min width */
            gap: 1rem;
            margin-top: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
            width: 100%; /* Asegura que la grilla ocupe el ancho del contenedor */
        }
        .person-card {
            background-color: #e0e7ff; /* Fondo azul claro */
            border: 1px solid #a7baff;
            border-radius: 0.5rem;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Empuja el estado hacia abajo */
            min-height: 90px; /* Altura mínima para las tarjetas */
        }
        .person-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .person-card-name {
            font-weight: bold;
            color: #003366;
            margin-bottom: 0.25rem;
            line-height: 1.2;
            flex-grow: 1; /* Permite que el nombre ocupe espacio */
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Limita el nombre a 2 líneas si es muy largo */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .person-card-status {
            font-size: 0.75rem;
            color: #4a5568;
            background-color: #c3daff; /* Fondo más claro para el estado */
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            margin-top: 0.5rem; /* Espacio arriba del estado */
            white-space: nowrap; /* Evita que el estado se rompa en varias líneas */
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .remove-card-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s, background-color 0.2s;
            line-height: 1; /* Asegura que la 'X' esté centrada */
            padding: 0;
        }
        .remove-card-btn:hover {
            opacity: 1;
            background-color: #c82333;
        }

        /* Estilos del Popover/Modal de edición */
        .popover-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .popover-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .popover-content {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            width: 350px;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            position: relative;
        }
        .popover-overlay.visible .popover-content {
            transform: translateY(0);
            opacity: 1;
        }
        .popover-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
        }
        .popover-close-btn:hover {
            color: #333;
        }
        .popover-content h4 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #003366;
            text-align: center;
        }
        .popover-content select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            font-size: 1rem;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3e%3cpath d='M7 7l3-3 3 3m0 6l-3 3-3-3' stroke='%234A5568' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em;
            accent-color: #003366;
        }
        .popover-content .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        .popover-content .button-group button {
            padding: 0.6rem 1.2rem;
            border-radius: 0.375rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }
        .popover-content .button-group .save-btn {
            background-color: #004080;
            color: white;
        }
        .popover-content .button-group .save-btn:hover {
            background-color: #0056b3;
        }
        .popover-content .button-group .cancel-btn {
            background-color: #e2e8f0;
            color: #4a5568;
        }
        .popover-content .button-group .cancel-btn:hover {
            background-color: #cbd5e0;
        }

        /* Estilos del resumen (modificaciones para estética) */
        .summary-box {
            background-color: #e6f0f9;
            border: 1px solid #b3d1f1;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
            text-align: center;
            width: 100%; /* Asegura que el resumen ocupe el ancho del contenedor */
        }
        .summary-section {
            padding: 1rem 0; /* Aumentado padding para más espacio */
            border-bottom: 1px dotted #cce0f5;
            text-align: left;
        }
        .summary-section:last-of-type {
            border-bottom: none;
        }
        .summary-section h4 {
            font-size: 1.125rem; /* Ajuste para consistencia */
            color: #2d3748; /* Color un poco más oscuro */
            margin-bottom: 0.75rem; /* Margen inferior para el título de sección */
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0; /* Aumentado padding vertical */
        }
        .summary-item span:first-child {
            font-weight: bold;
            color: #003366;
            flex-grow: 1; /* Permite que el texto del nombre ocupe más espacio */
        }
        .summary-item span:last-child {
            font-weight: bold;
            color: #003366;
            font-size: 1.1rem; /* Ligeramente más grande para los totales */
            min-width: 25px; /* Ancho mínimo para alinear números */
            text-align: right;
        }

        /* Estilos específicos para el desglose con dropdowns */
        .summary-item.with-dropdown {
            flex-direction: column;
            align-items: flex-start;
            padding: 0.75rem 0; /* Un poco más de padding */
        }
        .summary-item.with-dropdown > span:first-child {
            width: 100%;
            margin-bottom: 0.5rem;
            font-size: 1rem; /* Ajuste para el título del desglose */
            text-align: left; /* Alinea el título del desglose a la izquierda */
        }
        @media (min-width: 640px) {
            .summary-item.with-dropdown {
                flex-direction: row;
                align-items: flex-start;
            }
            .summary-item.with-dropdown > span:first-child {
                width: auto;
                margin-bottom: 0;
            }
        }
        .personnel-dropdown {
            font-size: 0.8rem; /* Ligeramente más grande para los nombres */
            color: #4a5568;
            margin-top: 0.5rem; /* Más espacio arriba del cuadro de nombres */
            padding: 0.75rem; /* Más padding interno */
            background-color: #f9fbfd;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            display: none;
            line-height: 1.5; /* Mayor espaciado entre líneas */
            max-height: 180px; /* Altura máxima ligeramente mayor */
            overflow-y: auto;
            flex-grow: 1;
            width: 100%; /* Asegura que ocupe todo el ancho disponible */
            text-align: left; /* Alinea el texto a la izquierda dentro del dropdown */
        }
        .personnel-dropdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .personnel-dropdown li {
            padding: 0.15rem 0; /* Más espacio entre nombres */
            border-bottom: 1px dotted #ebf1f7; /* Borde sutil entre nombres */
        }
        .personnel-dropdown li:last-child {
            border-bottom: none;
        }
        .personnel-dropdown:empty {
            display: none;
        }
        .add-person-section {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
            width: 100%; /* Asegura que la sección ocupe el ancho del contenedor */
        }
        @media (min-width: 640px) {
            .add-person-section {
                flex-direction: row;
                align-items: center;
            }
        }
        .add-person-section input, .filter-section select {
            flex-grow: 1;
            padding: 0.5rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.375rem;
            width: 100%;
        }
        .button-armada {
            background-color: #004080;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.375rem;
            font-weight: bold;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
            width: 100%;
        }
        @media (min-width: 640px) {
            .button-armada {
                width: auto;
            }
        }
        .button-armada:hover {
            background-color: #0056b3;
        }

        /* Clase para ocultar elementos temporalmente durante la captura */
        .hide-for-capture {
            display: none !important;
        }

        /* Estilo para el botón de toggle */
        .toggle-btn {
            background: none;
            border: none;
            font-size: 0.85rem; /* Ajuste de tamaño */
            color: #003366;
            cursor: pointer;
            margin-left: 0.75rem; /* Más margen */
            font-weight: normal;
            padding: 0.25rem 0.5rem; /* Pequeño padding para área de clic */
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .toggle-btn:hover:not(:disabled) {
            background-color: #cce0f5;
        }
        .toggle-btn:disabled {
            color: #a0aec0;
            cursor: not-allowed;
        }
        .summary-header-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        /* Estilos para los títulos principales en el contenedor */
        .container-armada h2 {
            margin-bottom: 1.5rem; /* Espacio debajo del título principal */
            width: 100%; /* Asegura que el título ocupe el ancho del contenedor */
            text-align: center;
        }
        .summary-box h3 {
            margin-bottom: 1.5rem; /* Espacio debajo del título del resumen */
            text-align: center;
        }

        /* Estilos para la sección de filtro y búsqueda */
        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
            width: 100%; /* Asegura que la sección ocupe el ancho del contenedor */
        }
        @media (min-width: 640px) {
            .filter-section {
                flex-direction: row;
                align-items: center;
            }
        }
        .filter-section input, .filter-section select {
            flex-grow: 1;
        }
        .title-input {
            width: 100%;
            font-size: 2.25rem; /* text-3xl */
            font-weight: bold;
            text-align: center;
            background: none;
            border: none;
            color: #ffffff;
            padding: 0;
            margin: 0;
            line-height: 1.2;
            cursor: pointer;
        }
        .title-input:hover {
            text-decoration: underline;
        }
        .title-input:focus {
            outline: 2px solid #ffcc00;
            outline-offset: 2px;
            border-radius: 4px;
            cursor: text;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center" id="full-page-content-to-capture"> 
    <header class="header-armada w-full">
        <input type="text" id="department-title-input" class="title-input" value="Parte Dpto. Finanzas y Abastecimiento EMGA 2025">
        <div class="last-updated" id="last-updated"></div>
    </header>

    <div class="container-armada mt-8 mb-8"> <h2 class="text-2xl font-semibold text-gray-800">Estado del Personal</h2>

        <div class="filter-section">
            <input type="text" id="search-input" placeholder="Buscar personal por nombre...">
            <select id="status-filter" class="w-full sm:w-auto">
                <option value="all">Todos los estados</option>
                <option value="forman">Forman</option>
                <option value="conmotivo">Con motivo</option>
                <option value="">Sin motivo</option>
                <option value="alto mando">Alto mando</option>
                <option value="en trabajos">En trabajos</option>
                <option value="en comisión">En comisión</option>
                <option value="de baja">De baja</option>
                <option value="con permiso">Con permiso</option>
            </select>
        </div>

        <div id="personnel-grid">
        </div>

        <div class="add-person-section">
            <input type="text" id="new-person-name" placeholder="Escriba el nombre completo de la persona a agregar">
            <button type="button" id="add-person-btn" class="button-armada">Agregar Persona</button>
        </div>

        <div class="summary-box">
            <h3 class="text-xl font-semibold text-gray-800">Resumen General</h3>

            <div class="summary-section">
                <div class="summary-item">
                    <span>Fuerza Efectiva:</span>
                    <span id="effective-force-count">0</span>
                </div>
            </div>

            <div class="summary-section">
                <div class="summary-item with-dropdown">
                    <div class="summary-header-item">
                        <span>Forman:</span>
                        <span id="forman-count-num">0</span>
                        <button class="toggle-btn" data-target="forman-dropdown">Mostrar</button>
                    </div>
                    <div class="personnel-dropdown" id="forman-dropdown"></div>
                </div>
            </div>

            <div class="summary-section">
                <div class="summary-item with-dropdown">
                    <div class="summary-header-item">
                        <span>Con motivo:</span>
                        <span id="conmotivo-count-num">0</span>
                        <button class="toggle-btn" data-target="conmotivo-dropdown">Mostrar</button>
                    </div>
                    <div class="personnel-dropdown" id="conmotivo-dropdown"></div>
                </div>
            </div>

            <div class="summary-section">
                <div class="summary-item with-dropdown">
                    <div class="summary-header-item">
                        <span>Sin motivo:</span>
                        <span id="sinmotivo-count-num">0</span>
                        <button class="toggle-btn" data-target="sinmotivo-dropdown">Mostrar</button>
                    </div>
                    <div class="personnel-dropdown" id="sinmotivo-dropdown"></div>
                </div>
            </div>

            <div class="summary-section mt-6" id="full-detail-section" style="display: none;">
                <h4 class="text-lg font-semibold text-gray-700">Detalle Completo por Categoría</h4>
                <div class="summary-item with-dropdown">
                    <span>Alto mando:</span>
                    <div class="personnel-dropdown" id="altomando-dropdown-full"></div>
                </div>
                <div class="summary-item with-dropdown">
                    <span>En trabajos:</span>
                    <div class="personnel-dropdown" id="trabajos-dropdown-full"></div>
                </div>
                <div class="summary-item with-dropdown">
                    <span>En comisión:</span>
                    <div class="personnel-dropdown" id="comision-dropdown-full"></div>
                </div>
                <div class="summary-item with-dropdown">
                    <span>De baja:</span>
                    <div class="personnel-dropdown" id="baja-dropdown-full"></div>
                </div>
                <div class="summary-item with-dropdown">
                    <span>Con permiso:</span>
                    <div class="personnel-dropdown" id="permiso-dropdown-full"></div>
                </div>
            </div>
        </div>
        <button type="button" id="download-summary-btn" class="button-armada mt-6 w-full bg-green-600 hover:bg-green-700">Descargar Resumen como Imagen</button>
    </div>

    <div class="popover-overlay" id="edit-status-popover">
        <div class="popover-content">
            <button class="popover-close-btn" id="popover-close-btn">&times;</button>
            <h4 id="popover-person-name"></h4>
            <select id="popover-status-select">
                <option value="">Seleccione estado</option>
            </select>
            <div class="button-group">
                <button class="save-btn" id="popover-save-btn">Guardar</button>
                <button class="cancel-btn" id="popover-cancel-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const personnelGrid = document.getElementById('personnel-grid');
            const addPersonBtn = document.getElementById('add-person-btn');
            const newPersonNameInput = document.getElementById('new-person-name');
            const lastUpdatedElement = document.getElementById('last-updated');
            const downloadSummaryBtn = document.getElementById('download-summary-btn');
            
            // EL CONTENEDOR PRINCIPAL A CAPTURAR AHORA ES EL BODY
            const fullPageContentToCapture = document.getElementById('full-page-content-to-capture'); 
            const fullDetailSection = document.getElementById('full-detail-section');

            const editStatusPopover = document.getElementById('edit-status-popover');
            const popoverCloseBtn = document.getElementById('popover-close-btn');
            const popoverCancelBtn = document.getElementById('popover-cancel-btn');
            const popoverSaveBtn = document.getElementById('popover-save-btn');
            const popoverPersonName = document.getElementById('popover-person-name');
            const popoverStatusSelect = document.getElementById('popover-status-select');

            const searchInput = document.getElementById('search-input');
            const statusFilterSelect = document.getElementById('status-filter');
            const departmentTitleInput = document.getElementById('department-title-input');

            const personnelDataKey = 'personnelDataEmga2025';
            const lastUpdatedKey = 'lastUpdatedEmga2025';
            const departmentTitleKey = 'departmentTitleEmga2025';

            let personnel = [];
            let currentEditingPersonId = null;

            const initialPersonnelNames = [
                'T1 ANDRÉS VARAS',
                'PAC RAÚL DÍAZ',
                'SO GERMÁN CASTRO',
                'SO JUAN MUÑOZ',
                'SO ALFONSO ESPINOZA',
                'S1 CARLOS ALARCÓN',
                'S1 JORGE ESPINOZA',
                'S1 CARLOS JIMÉNEZ',
                'S1 ROBERTO ALEGRIA',
                'S1 MARCOS ERAZO',
                'S1 GREGORY FUENTES',
                'S2 GABRIEL CLAVERÍA',
                'S2 JOSUÉ RAÍN',
                'C1 JONATAN MORAGA',
                'C1 SAMI DONOSO',
                'TT PEDRO VERDUGO'
            ];

            const categories = [
                { value: '', text: 'Sin motivo' },
                { value: 'alto mando', text: 'Alto mando' },
                { value: 'forman', text: 'Forman' },
                { value: 'en trabajos', text: 'En trabajos' },
                { value: 'en comisión', text: 'En comisión' },
                { value: 'de baja', text: 'De baja' },
                { value: 'con permiso', text: 'Con permiso' }
            ];

            function populatePopoverCategories() {
                popoverStatusSelect.innerHTML = '<option value="">Seleccione estado</option>';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.value;
                    option.textContent = cat.text;
                    popoverStatusSelect.appendChild(option);
                });
            }

            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            }

            function savePersonnelData() {
                try {
                    localStorage.setItem(personnelDataKey, JSON.stringify(personnel));
                    updateLastUpdatedTime();
                } catch (error) {
                    console.warn('No se pudo guardar en localStorage:', error);
                }
            }

            function loadPersonnelData() {
                try {
                    const storedData = localStorage.getItem(personnelDataKey);
                    if (storedData) {
                        const loadedPersonnel = JSON.parse(storedData);
                        const loadedPersonnelMap = new Map(loadedPersonnel.map(p => [p.name, p]));

                        personnel = [];
                        initialPersonnelNames.forEach(name => {
                            if (loadedPersonnelMap.has(name)) {
                                const person = loadedPersonnelMap.get(name);
                                if (person.status === 'a bordo') {
                                    person.status = 'forman';
                                }
                                personnel.push(person);
                                loadedPersonnelMap.delete(name);
                            } else {
                                personnel.push({ id: generateId(), name: name, status: '' });
                            }
                        });

                        loadedPersonnel.forEach(p => {
                            if (!initialPersonnelNames.includes(p.name)) {
                                if (p.status === 'a bordo') {
                                    p.status = 'forman';
                                }
                                personnel.push(p);
                            }
                        });
                    } else {
                        personnel = initialPersonnelNames.map(name => ({
                            id: generateId(),
                            name: name,
                            status: ''
                        }));
                    }
                } catch (error) {
                    console.warn('Error al cargar datos:', error);
                    personnel = initialPersonnelNames.map(name => ({
                        id: generateId(),
                        name: name,
                        status: ''
                    }));
                }
                renderPersonnelGrid();
            }

            function updateLastUpdatedTime() {
                const now = new Date();
                const options = {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZoneName: 'short',
                    hour12: false
                };
                try {
                    // Formato específico para Chile
                    const formattedDate = new Intl.DateTimeFormat('es-CL', {
                        ...options,
                        timeZone: 'America/Santiago' // Zona horaria de Chile Continental
                    }).format(now);
                    lastUpdatedElement.textContent = `Última actualización: ${formattedDate}`;
                    localStorage.setItem(lastUpdatedKey, formattedDate);
                } catch (error) {
                    console.warn('Error al actualizar tiempo:', error);
                    lastUpdatedElement.textContent = `Última actualización: ${now.toLocaleString()}`;
                }
            }

            function loadLastUpdatedTime() {
                try {
                    const storedTime = localStorage.getItem(lastUpdatedKey);
                    if (storedTime) {
                        lastUpdatedElement.textContent = `Última actualización: ${storedTime}`;
                    } else {
                        updateLastUpdatedTime(); // Si no hay tiempo guardado, establecerlo ahora
                    }
                } catch (error) {
                    console.warn('Error al cargar tiempo:', error);
                    lastUpdatedElement.textContent = 'Última actualización: Nunca';
                }
            }

            function saveDepartmentTitle(title) {
                try {
                    localStorage.setItem(departmentTitleKey, title);
                } catch (error) {
                    console.warn('No se pudo guardar el título del departamento:', error);
                }
            }

            function loadDepartmentTitle() {
                try {
                    const storedTitle = localStorage.getItem(departmentTitleKey);
                    if (storedTitle) {
                        departmentTitleInput.value = storedTitle;
                    }
                } catch (error) {
                    console.warn('Error al cargar el título del departamento:', error);
                }
            }

            function createPersonCard(person) {
                const card = document.createElement('div');
                card.className = 'person-card';
                card.dataset.id = person.id;

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-card-btn';
                removeBtn.textContent = 'X';
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removePerson(person.id);
                });

                const nameDiv = document.createElement('div');
                nameDiv.className = 'person-card-name';
                nameDiv.textContent = person.name;

                let displayStatus = 'Sin motivo';
                if (person.status === 'forman') {
                    displayStatus = 'A bordo';
                } else if (person.status !== '') {
                    displayStatus = categories.find(cat => cat.value === person.status)?.text || 'Sin estado';
                }
                
                const statusDiv = document.createElement('div');
                statusDiv.className = 'person-card-status';
                statusDiv.textContent = displayStatus;

                card.appendChild(removeBtn);
                card.appendChild(nameDiv);
                card.appendChild(statusDiv);

                card.addEventListener('click', () => openEditPopover(person));

                return card;
            }

            function renderPersonnelGrid() {
                personnelGrid.innerHTML = '';
                const searchTerm = searchInput.value.toLowerCase();
                const filterStatus = statusFilterSelect.value;

                const filteredPersonnel = personnel.filter(person => {
                    const matchesSearch = person.name.toLowerCase().includes(searchTerm);
                    
                    let matchesFilterStatus = true;
                    if (filterStatus === 'forman') {
                        matchesFilterStatus = person.status === 'forman';
                    } else if (filterStatus === 'conmotivo') {
                        matchesFilterStatus = ['alto mando', 'en trabajos', 'en comisión', 'de baja', 'con permiso'].includes(person.status);
                    } else if (filterStatus === '') { // Filtra por "Sin motivo"
                        matchesFilterStatus = person.status === '';
                    } else if (filterStatus !== 'all') {
                        matchesFilterStatus = person.status === filterStatus;
                    }
                    return matchesSearch && matchesFilterStatus;
                });

                if (filteredPersonnel.length === 0) {
                    personnelGrid.innerHTML = '<p class="text-center text-gray-500 mt-4 col-span-full">No se encontraron personas con los criterios de búsqueda o filtro.</p>';
                } else {
                    filteredPersonnel.forEach(person => {
                        personnelGrid.appendChild(createPersonCard(person));
                    });
                }
                updateSummary();
            }

            function addPerson() {
                const name = newPersonNameInput.value.trim();
                if (name) {
                    if (personnel.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                        alert('Esta persona ya existe en la lista.');
                        return;
                    }

                    const newPerson = {
                        id: generateId(),
                        name: name,
                        status: ''
                    };
                    personnel.push(newPerson);
                    newPersonNameInput.value = '';
                    savePersonnelData();
                    renderPersonnelGrid();
                } else {
                    alert('Por favor, ingrese un nombre para la persona.');
                }
            }

            function removePerson(idToRemove) {
                if (confirm('¿Está seguro de que desea eliminar a esta persona?')) {
                    personnel = personnel.filter(person => person.id !== idToRemove);
                    savePersonnelData();
                    renderPersonnelGrid();
                }
            }

            function openEditPopover(person) {
                currentEditingPersonId = person.id;
                popoverPersonName.textContent = person.name;
                popoverStatusSelect.value = person.status;
                editStatusPopover.classList.add('visible');
            }

            function closeEditPopover() {
                editStatusPopover.classList.remove('visible');
                currentEditingPersonId = null;
            }

            function savePopoverChanges() {
                if (currentEditingPersonId) {
                    const personToUpdate = personnel.find(p => p.id === currentEditingPersonId);
                    if (personToUpdate) {
                        personToUpdate.status = popoverStatusSelect.value;
                        savePersonnelData();
                        renderPersonnelGrid();
                    }
                }
                closeEditPopover();
            }

            function updateSummary() {
                const effectiveForceCount = personnel.length;
                let formanPersonnel = [];
                let conMotivoPersonnel = [];
                let sinMotivoPersonnel = [];
                const personnelByFullCategory = {
                    'alto mando': [],
                    'en trabajos': [],
                    'en comisión': [],
                    'de baja': [],
                    'con permiso': []
                };

                personnel.forEach(person => {
                    const status = person.status;
                    if (status === 'forman') {
                        formanPersonnel.push(person.name);
                    } else if (['alto mando', 'en trabajos', 'en comisión', 'de baja', 'con permiso'].includes(status)) {
                        conMotivoPersonnel.push(person.name);
                        personnelByFullCategory[status].push(person.name);
                    } else if (status === '') {
                        sinMotivoPersonnel.push(person.name);
                    }
                });

                document.getElementById('effective-force-count').textContent = effectiveForceCount;
                document.getElementById('forman-count-num').textContent = formanPersonnel.length;
                document.getElementById('conmotivo-count-num').textContent = conMotivoPersonnel.length;
                document.getElementById('sinmotivo-count-num').textContent = sinMotivoPersonnel.length;

                const dropdownsInfo = [
                    { id: 'forman-dropdown', names: formanPersonnel, toggleBtnSelector: '[data-target="forman-dropdown"]', emptyMsg: 'No hay personal en Forman.' },
                    { id: 'conmotivo-dropdown', names: conMotivoPersonnel, toggleBtnSelector: '[data-target="conmotivo-dropdown"]', emptyMsg: 'No hay personal en Con motivo.' },
                    { id: 'sinmotivo-dropdown', names: sinMotivoPersonnel, toggleBtnSelector: '[data-target="sinmotivo-dropdown"]', emptyMsg: 'No hay personal Sin motivo.' },
                    { id: 'altomando-dropdown-full', names: personnelByFullCategory['alto mando'], emptyMsg: 'No hay personal en Alto mando.' },
                    { id: 'trabajos-dropdown-full', names: personnelByFullCategory['en trabajos'], emptyMsg: 'No hay personal en En trabajos.' },
                    { id: 'comision-dropdown-full', names: personnelByFullCategory['en comisión'], emptyMsg: 'No hay personal en En comisión.' },
                    { id: 'baja-dropdown-full', names: personnelByFullCategory['de baja'], emptyMsg: 'No hay personal en De baja.' },
                    { id: 'permiso-dropdown-full', names: personnelByFullCategory['con permiso'], emptyMsg: 'No hay personal en Con permiso.' }
                ];

                dropdownsInfo.forEach(info => {
                    const dropdown = document.getElementById(info.id);
                    const toggleButton = info.toggleBtnSelector ? document.querySelector(info.toggleBtnSelector) : null;

                    if (info.names.length > 0) {
                        dropdown.innerHTML = '<ul>' + info.names.map(name => `<li>${name}</li>`).join('') + '</ul>';
                        if (toggleButton) {
                            toggleButton.disabled = false;
                        }
                    } else {
                        dropdown.innerHTML = `<p class="text-center text-gray-500 text-sm italic py-2">${info.emptyMsg}</p>`;
                        dropdown.style.display = 'none'; // Asegura que estén ocultos
                        if (toggleButton) {
                            toggleButton.disabled = true;
                            toggleButton.textContent = 'Mostrar'; // Restablecer texto si estaba Plegar
                        }
                    }
                    // For full detail dropdowns, ensure they are hidden by default after update
                    if (info.id.includes('-full')) {
                        dropdown.style.display = 'none';
                    }
                });

                // Update toggle button text based on current display state
                document.querySelectorAll('.toggle-btn').forEach(btn => {
                    const targetId = btn.dataset.target;
                    const dropdown = document.getElementById(targetId);
                    if (dropdown && !btn.disabled) {
                        if (dropdown.style.display === 'block') {
                            btn.textContent = 'Plegar';
                        } else {
                            btn.textContent = 'Mostrar';
                        }
                    }
                });
            }

            function toggleDropdown(button) {
                const targetId = button.dataset.target;
                const dropdown = document.getElementById(targetId);
                if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                    dropdown.style.display = 'block';
                    button.textContent = 'Plegar';
                } else {
                    dropdown.style.display = 'none';
                    button.textContent = 'Mostrar';
                }
            }

            function downloadSummaryAsImage() {
                // Seleccionar todos los elementos que no deben aparecer en la captura
                const elementsToHideForCapture = [
                    document.querySelector('.filter-section'),
                    document.getElementById('personnel-grid'),
                    document.querySelector('.add-person-section'),
                    document.getElementById('download-summary-btn'),
                    editStatusPopover // También ocultar el popover si estuviera abierto
                ].filter(Boolean); // Filtrar nulls si algún elemento no existe

                elementsToHideForCapture.forEach(el => el.classList.add('hide-for-capture'));

                // Guardar y modificar el estado del input del título temporalmente para la captura
                const originalTitleInputState = {
                    readOnly: departmentTitleInput.readOnly,
                    cursor: departmentTitleInput.style.cursor,
                    outline: departmentTitleInput.style.outline
                };
                departmentTitleInput.readOnly = true;
                departmentTitleInput.style.cursor = 'default';
                departmentTitleInput.style.outline = 'none';
                
                // Expandir la sección de "Detalle Completo por Categoría" si está oculta
                let wasFullDetailSectionHidden = false;
                if (fullDetailSection && fullDetailSection.style.display === 'none') {
                    wasFullDetailSectionHidden = true;
                    fullDetailSection.style.display = 'block';
                }

                // Asegurarse de que todos los dropdowns de resumen estén visibles y expandidos para la captura
                const dropdownsToExpandForCapture = [
                    'forman-dropdown',
                    'conmotivo-dropdown',
                    'sinmotivo-dropdown',
                    'altomando-dropdown-full',
                    'trabajos-dropdown-full',
                    'comision-dropdown-full',
                    'baja-dropdown-full',
                    'permiso-dropdown-full'
                ];
                const originalDropdownStates = {}; 

                dropdownsToExpandForCapture.forEach(id => {
                    const dropdown = document.getElementById(id);
                    if (dropdown) {
                        originalDropdownStates[id] = {
                            display: dropdown.style.display,
                            maxHeight: dropdown.style.maxHeight,
                            overflow: dropdown.style.overflow
                        };
                        dropdown.style.display = 'block';
                        dropdown.style.maxHeight = 'none';
                        dropdown.style.overflow = 'visible';
                    }
                });

                // Captura el body completo (que ahora tiene el ID 'full-page-content-to-capture')
                html2canvas(fullPageContentToCapture, {
                    scale: 2, // Mayor escala para mejor calidad de imagen
                    logging: false,
                    useCORS: true,
                    windowWidth: document.documentElement.scrollWidth, // Capturar el ancho completo de la página
                    windowHeight: document.documentElement.scrollHeight // Capturar la altura completa de la página
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `${departmentTitleInput.value.replace(/[^a-z0-9]/gi, '_')}_${new Date().toLocaleDateString('es-CL').replace(/\//g, '-')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                }).catch(error => {
                    console.error('Error al generar la imagen del resumen:', error);
                    alert('Hubo un error al generar la imagen del resumen.');
                }).finally(() => {
                    // Restaurar la visibilidad de los elementos ocultos
                    elementsToHideForCapture.forEach(el => el.classList.remove('hide-for-capture'));

                    // Restaurar el estado del input del título
                    departmentTitleInput.readOnly = originalTitleInputState.readOnly;
                    departmentTitleInput.style.cursor = originalTitleInputState.cursor;
                    departmentTitleInput.style.outline = originalTitleInputState.outline;
                    
                    // Restaurar la sección de detalle completo si estaba oculta
                    if (wasFullDetailSectionHidden && fullDetailSection) {
                        fullDetailSection.style.display = 'none';
                    }

                    // Restaurar el estado original de los dropdowns
                    dropdownsToExpandForCapture.forEach(id => {
                        const dropdown = document.getElementById(id);
                        if (dropdown && originalDropdownStates[id]) {
                            dropdown.style.display = originalDropdownStates[id].display;
                            dropdown.style.maxHeight = originalDropdownStates[id].maxHeight;
                            dropdown.style.overflow = originalDropdownStates[id].overflow;
                        }
                    });
                    
                    // Asegurarse de que los botones de toggle reflejen el estado actual de los dropdowns
                    document.querySelectorAll('.toggle-btn').forEach(btn => {
                        const targetId = btn.dataset.target;
                        const dropdown = document.getElementById(targetId);
                        if (dropdown && !btn.disabled) {
                            if (dropdown.style.display === 'block') {
                                btn.textContent = 'Plegar';
                            } else {
                                btn.textContent = 'Mostrar';
                            }
                        }
                    });
                });
            }

            // Event listeners
            addPersonBtn.addEventListener('click', addPerson);
            newPersonNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addPerson();
                }
            });
            downloadSummaryBtn.addEventListener('click', downloadSummaryAsImage);

            // Popover event listeners
            popoverCloseBtn.addEventListener('click', closeEditPopover);
            popoverCancelBtn.addEventListener('click', closeEditPopover);
            popoverSaveBtn.addEventListener('click', savePopoverChanges);
            editStatusPopover.addEventListener('click', (e) => {
                if (e.target === editStatusPopover) {
                    closeEditPopover();
                }
            });

            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('toggle-btn') && !e.target.disabled) {
                    toggleDropdown(e.target);
                }
            });

            // Event listeners para búsqueda y filtro
            searchInput.addEventListener('input', renderPersonnelGrid);
            statusFilterSelect.addEventListener('change', renderPersonnelGrid);

            // Event listeners para el título del departamento
            departmentTitleInput.addEventListener('change', (e) => saveDepartmentTitle(e.target.value));
            departmentTitleInput.addEventListener('blur', (e) => saveDepartmentTitle(e.target.value));


            // Inicialización
            populatePopoverCategories();
            loadPersonnelData();
            loadLastUpdatedTime();
            loadDepartmentTitle();
        });
    </script>
</body>
</html>
