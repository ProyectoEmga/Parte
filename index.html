<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parte Dpto. Finanzas y Abastecimiento EMGA 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f4f8;
        }
        .header-armada {
            background-color: #003366;
            color: #ffffff;
            padding: 1.5rem;
            text-align: center;
            border-bottom: 5px solid #ffcc00;
            position: relative;
        }
        .header-armada .last-updated {
            position: absolute;
            bottom: 0.5rem;
            right: 1rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }
        .container-armada {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-top: 2rem;
        }
        .person-row {
            display: flex;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .person-row:last-of-type {
            border-bottom: none;
        }
        .person-name {
            font-weight: bold;
            color: #003366;
            width: 180px;
            flex-shrink: 0;
        }
        .select-group {
            flex-grow: 1;
        }
        .select-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.375rem;
            background-color: #ffffff;
            color: #4a5568;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3e%3cpath d='M7 7l3-3 3 3m0 6l-3 3-3-3' stroke='%234A5568' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em;
            accent-color: #003366;
        }
        .summary-box {
            background-color: #e6f0f9;
            border: 1px solid #b3d1f1;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
            text-align: center;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dotted #cce0f5;
            flex-wrap: wrap; /* Permite que los elementos se envuelvan si el espacio es limitado */
            align-items: flex-start; /* Alinea los ítems al inicio para el dropdown */
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .summary-item span:first-child {
            font-weight: bold;
            color: #003366;
            margin-right: 1rem; /* Espacio entre el título y el contador */
            flex-basis: auto; /* Permite que el span ocupe el ancho necesario */
        }
        .summary-item span:nth-child(2) {
            flex-shrink: 0; /* Evita que el contador se encoja */
        }
        .personnel-dropdown {
            font-size: 0.75rem; /* Fuente más pequeña para los nombres en el resumen */
            color: #4a5568; /* Color más oscuro para los nombres */
            margin-top: 0.5rem;
            padding: 0.5rem 0.25rem; /* Aumentado el padding */
            text-align: left;
            width: 100%; /* Ocupa todo el ancho disponible */
            box-sizing: border-box; /* Incluye padding y borde en el ancho */
            background-color: #f9fbfd; /* Ligero color de fondo para el desplegable */
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            display: none; /* Se mantiene oculto por defecto */
            line-height: 1.4; /* Espaciado entre líneas */
            max-height: 150px; /* Altura máxima para evitar desbordamiento */
            overflow-y: auto; /* Scroll si hay muchos nombres */
        }
        .personnel-dropdown ul {
            list-style: none; /* Elimina viñetas de la lista */
            padding: 0;
            margin: 0;
        }
        .personnel-dropdown li {
            padding: 0.1rem 0; /* Menos padding para items de lista */
        }

        .personnel-dropdown:empty {
            display: none;
        }
        .add-person-section {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .add-person-section input {
            flex-grow: 1;
            padding: 0.5rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.375rem;
        }
        .button-armada {
            background-color: #004080;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.375rem;
            font-weight: bold;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
        }
        .button-armada:hover {
            background-color: #0056b3;
        }
        .remove-btn {
            background-color: #dc3545;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            margin-left: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
        }
        .remove-btn:hover {
            background-color: #c82333;
        }

        /* Estilos para el PDF y la imagen */
        .no-print {
            /* Por defecto, estos elementos no se imprimen ni se capturan en la imagen */
            /* En el JS se controlará su visibilidad temporalmente para la captura/PDF */
        }

        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background-color: #ffffff; /* Fondo blanco para el PDF */
            }
            .container-armada {
                box-shadow: none; /* Eliminar sombra en el PDF */
                margin-top: 0;
                padding: 1rem;
            }
            .header-armada {
                border-bottom: none;
                padding: 1rem;
            }
            .summary-box {
                border: none;
                background-color: #ffffff;
                padding: 1rem;
            }
            /* Asegurar que los desplegables se muestren en el PDF con su contenido completo */
            .personnel-dropdown {
                display: block !important;
                height: auto !important; /* Permitir que el contenido empuje la altura */
                max-height: none !important; /* Sin límite de altura en el PDF */
                overflow: visible !important; /* Mostrar todo el contenido */
                background-color: #f0f4f8; /* Color de fondo ligero para diferenciar */
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">
    <header class="header-armada w-full no-print">
        <h1 class="text-3xl font-bold">Parte Dpto. Finanzas y Abastecimiento EMGA 2025</h1>
        <div class="last-updated" id="last-updated"></div>
    </header>

    <div class="container-armada w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 mt-8 mb-8" id="content-to-pdf">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Estado del Personal</h2>

        <form id="personnelForm" class="no-print">
        </form>

        <div class="add-person-section no-print">
            <input type="text" id="new-person-name" placeholder="Ingrese nuevo nombre de persona">
            <button type="button" id="add-person-btn" class="button-armada">Agregar Persona</button>
        </div>

        <div class="summary-box" id="summary-box-to-capture">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Recuento de Personal</h3>
            <div id="summary-display">
                <div class="summary-item">
                    <span>Fuerza Efectiva:</span>
                    <span id="effective-force-count">0</span>
                </div>
                <div class="summary-item">
                    <span>Alto mando:</span>
                    <span id="altomando-count">0</span>
                    <div class="personnel-dropdown" id="altomando-dropdown"></div>
                </div>
                <div class="summary-item">
                    <span>A bordo:</span>
                    <span id="abordo-count">0</span>
                    <div class="personnel-dropdown" id="abordo-dropdown"></div>
                </div>
                <div class="summary-item">
                    <span>En trabajos:</span>
                    <span id="trabajos-count">0</span>
                    <div class="personnel-dropdown" id="trabajos-dropdown"></div>
                </div>
                <div class="summary-item">
                    <span>En comisión:</span>
                    <span id="comision-count">0</span>
                    <div class="personnel-dropdown" id="comision-dropdown"></div>
                </div>
                <div class="summary-item">
                    <span>De baja:</span>
                    <span id="baja-count">0</span>
                    <div class="personnel-dropdown" id="baja-dropdown"></div>
                </div>
                <div class="summary-item">
                    <span>Con permiso:</span>
                    <span id="permiso-count">0</span>
                    <div class="personnel-dropdown" id="permiso-dropdown"></div>
                </div>
            </div>
        </div>
        <button type="button" id="generate-pdf-btn" class="button-armada mt-6 w-full no-print">Generar PDF</button>
        <button type="button" id="download-summary-btn" class="button-armada mt-2 w-full no-print bg-green-600 hover:bg-green-700">Descargar Resumen como Imagen</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('personnelForm');
            const addPersonBtn = document.getElementById('add-person-btn');
            const newPersonNameInput = document.getElementById('new-person-name');
            const lastUpdatedElement = document.getElementById('last-updated');
            const generatePdfBtn = document.getElementById('generate-pdf-btn');
            const downloadSummaryBtn = document.getElementById('download-summary-btn'); // Nuevo botón de imagen
            const contentToPdf = document.getElementById('content-to-pdf');
            const summaryBoxToCapture = document.getElementById('summary-box-to-capture'); // El div del resumen

            const personnelDataKey = 'personnelDataEmga2025';
            const lastUpdatedKey = 'lastUpdatedEmga2025';

            let personnel = [];

            // Lista de personal en el orden deseado
            const initialPersonnelNames = [
                'T1 ANDRÉS VARAS',
                'PAC RAÚL DÍAZ',
                'SO GERMÁN CASTRO',
                'SO JUAN MUÑOZ',
                'SO ALFONSO ESPINOZA',
                'S1 CARLOS ALARCÓN',
                'S1 JORGE ESPINOZA',
                'S1 CARLOS JIMÉNEZ',
                'S1 GREGORY FUENTES',
                'S2 GABRIEL CLAVERÍA',
                'S2 JOSUÉ RAÍN',
                'C1 JONATAN MORAGA',
                'C1 SAMI DONOSO',
                'TT PEDRO VERDUGO'
            ];

            const categories = [
                { value: 'alto mando', text: 'Alto mando' },
                { value: 'a bordo', text: 'A bordo' },
                { value: 'en trabajos', text: 'En trabajos' },
                { value: 'en comisión', text: 'En comisión' },
                { value: 'de baja', text: 'De baja' },
                { value: 'con permiso', text: 'Con permiso' }
            ];

            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            }

            function savePersonnelData() {
                try {
                    localStorage.setItem(personnelDataKey, JSON.stringify(personnel));
                    updateLastUpdatedTime();
                } catch (error) {
                    console.warn('No se pudo guardar en localStorage:', error);
                }
            }

            function loadPersonnelData() {
                try {
                    const storedData = localStorage.getItem(personnelDataKey);
                    if (storedData) {
                        const loadedPersonnel = JSON.parse(storedData);
                        const loadedPersonnelMap = new Map(loadedPersonnel.map(p => [p.name, p]));

                        personnel = [];
                        // Asegurar que el personal inicial esté en el orden especificado
                        initialPersonnelNames.forEach(name => {
                            if (loadedPersonnelMap.has(name)) {
                                personnel.push(loadedPersonnelMap.get(name));
                                loadedPersonnelMap.delete(name); // Eliminar del mapa para no duplicar
                            } else {
                                personnel.push({ id: generateId(), name: name, status: '' });
                            }
                        });

                        // Añadir cualquier personal extra que no esté en la lista inicial, manteniendo su orden relativo
                        loadedPersonnel.forEach(p => {
                            if (!initialPersonnelNames.includes(p.name)) {
                                personnel.push(p);
                            }
                        });
                    } else {
                        // Si no hay datos guardados, usar solo la lista inicial
                        personnel = initialPersonnelNames.map(name => ({
                            id: generateId(),
                            name: name,
                            status: ''
                        }));
                    }
                } catch (error) {
                    console.warn('Error al cargar datos:', error);
                    // Fallback si hay un error de carga
                    personnel = initialPersonnelNames.map(name => ({
                        id: generateId(),
                        name: name,
                        status: ''
                    }));
                }
                renderPersonnelList();
            }

            function updateLastUpdatedTime() {
                const now = new Date();
                const options = {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZoneName: 'short',
                    hour12: false
                };
                try {
                    const formattedDate = new Intl.DateTimeFormat('es-CL', {
                        ...options,
                        timeZone: 'America/Santiago'
                    }).format(now);
                    lastUpdatedElement.textContent = `Última actualización: ${formattedDate}`;
                    localStorage.setItem(lastUpdatedKey, formattedDate);
                } catch (error) {
                    console.warn('Error al actualizar tiempo:', error);
                    lastUpdatedElement.textContent = `Última actualización: ${now.toLocaleString()}`;
                }
            }

            function loadLastUpdatedTime() {
                try {
                    const storedTime = localStorage.getItem(lastUpdatedKey);
                    if (storedTime) {
                        lastUpdatedElement.textContent = `Última actualización: ${storedTime}`;
                    } else {
                        lastUpdatedElement.textContent = 'Última actualización: Nunca';
                    }
                } catch (error) {
                    console.warn('Error al cargar tiempo:', error);
                    lastUpdatedElement.textContent = 'Última actualización: Nunca';
                }
            }

            function createPersonRow(person) {
                const row = document.createElement('div');
                row.className = 'person-row';
                row.id = `person-${person.id}`;

                row.innerHTML = `
                    <div class="person-name">${person.name}</div>
                    <div class="select-group">
                        <select id="status-${person.id}" name="status-${person.id}" class="person-status-select">
                            <option value="">Seleccione estado</option>
                            ${categories.map(cat => `<option value="${cat.value}" ${person.status === cat.value ? 'selected' : ''}>${cat.text}</option>`).join('')}
                        </select>
                    </div>
                    <button type="button" class="remove-btn" data-id="${person.id}">Eliminar</button>
                `;

                const selectElement = row.querySelector(`#status-${person.id}`);
                selectElement.addEventListener('change', (e) => {
                    person.status = e.target.value;
                    savePersonnelData();
                    updateSummary();
                });

                const removeBtn = row.querySelector('.remove-btn');
                removeBtn.addEventListener('click', () => {
                    removePerson(person.id);
                });

                return row;
            }

            function renderPersonnelList() {
                form.innerHTML = '';
                // No ordenar alfabéticamente aquí, usar el orden de 'personnel'
                personnel.forEach(person => {
                    form.appendChild(createPersonRow(person));
                });
                updateSummary();
            }

            function addPerson() {
                const name = newPersonNameInput.value.trim();
                if (name) {
                    if (personnel.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                        alert('Esta persona ya existe en la lista.');
                        return;
                    }

                    const newPerson = {
                        id: generateId(),
                        name: name,
                        status: ''
                    };
                    personnel.push(newPerson);
                    newPersonNameInput.value = '';
                    savePersonnelData();
                    renderPersonnelList();
                } else {
                    alert('Por favor, ingrese un nombre para la persona.');
                }
            }

            function removePerson(idToRemove) {
                if (confirm('¿Está seguro de que desea eliminar a esta persona?')) {
                    personnel = personnel.filter(person => person.id !== idToRemove);
                    savePersonnelData();
                    renderPersonnelList();
                }
            }

            function updateSummary() {
                const counts = {
                    'effectiveForce': personnel.length,
                    'alto mando': 0,
                    'a bordo': 0,
                    'en trabajos': 0,
                    'en comisión': 0,
                    'de baja': 0,
                    'con permiso': 0
                };

                const personnelByCategory = {
                    'alto mando': [],
                    'a bordo': [],
                    'en trabajos': [],
                    'en comisión': [],
                    'de baja': [],
                    'con permiso': []
                };

                personnel.forEach(person => {
                    if (categories.some(cat => cat.value === person.status)) {
                        counts[person.status]++;
                        personnelByCategory[person.status].push(person.name);
                    }
                });

                document.getElementById('effective-force-count').textContent = counts.effectiveForce;
                document.getElementById('altomando-count').textContent = counts['alto mando'];
                document.getElementById('abordo-count').textContent = counts['a bordo'];
                document.getElementById('trabajos-count').textContent = counts['en trabajos'];
                document.getElementById('comision-count').textContent = counts['en comisión'];
                document.getElementById('baja-count').textContent = counts['de baja'];
                document.getElementById('permiso-count').textContent = counts['con permiso'];

                const dropdownMappings = {
                    'alto mando': 'altomando-dropdown',
                    'a bordo': 'abordo-dropdown',
                    'en trabajos': 'trabajos-dropdown',
                    'en comisión': 'comision-dropdown',
                    'de baja': 'baja-dropdown',
                    'con permiso': 'permiso-dropdown'
                };

                Object.keys(dropdownMappings).forEach(category => {
                    const dropdown = document.getElementById(dropdownMappings[category]);
                    const names = personnelByCategory[category];

                    if (names.length > 0) {
                        // Mantener el orden original o usar el orden predeterminado en que se agregaron
                        // y generar lista con elementos li
                        dropdown.innerHTML = '<ul>' + names.map(name => `<li>${name}</li>`).join('') + '</ul>';
                        dropdown.style.display = 'block';
                    } else {
                        dropdown.innerHTML = '';
                        dropdown.style.display = 'none';
                    }
                });
            }

            // Función para generar PDF
            function generatePDF() {
                const options = {
                    margin: 10,
                    filename: 'Parte_Finanzas_Abastecimiento_EMGA_2025.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                // Ocultar elementos no deseados antes de la generación del PDF
                const noPrintElements = document.querySelectorAll('.no-print');
                noPrintElements.forEach(el => el.style.display = 'none');

                html2pdf().from(contentToPdf).set(options).save().then(() => {
                    // Restaurar la visibilidad de los elementos después de la generación
                    noPrintElements.forEach(el => el.style.display = '');
                });
            }

            // Función para descargar el cuadro de resumen como imagen
            function downloadSummaryAsImage() {
                // Ocultar los botones de control para la captura de imagen
                const noPrintElements = document.querySelectorAll('.no-print');
                noPrintElements.forEach(el => el.style.display = 'none');

                html2canvas(summaryBoxToCapture, {
                    scale: 2, // Aumentar la escala para mayor resolución
                    logging: true,
                    useCORS: true // Importante si tienes imágenes de fondo o fuentes externas
                }).then(canvas => {
                    // Crear un enlace temporal para la descarga
                    const link = document.createElement('a');
                    link.download = 'Resumen_Personal_EMGA.png';
                    link.href = canvas.toDataURL('image/png');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // Restaurar la visibilidad de los elementos
                    noPrintElements.forEach(el => el.style.display = '');
                }).catch(error => {
                    console.error('Error al generar la imagen del resumen:', error);
                    alert('Hubo un error al generar la imagen del resumen.');
                    // Asegurarse de restaurar la visibilidad incluso en caso de error
                    noPrintElements.forEach(el => el.style.display = '');
                });
            }

            // Event listeners
            addPersonBtn.addEventListener('click', addPerson);
            newPersonNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addPerson();
                }
            });
            generatePdfBtn.addEventListener('click', generatePDF);
            downloadSummaryBtn.addEventListener('click', downloadSummaryAsImage); // Event listener para el botón de imagen

            // Inicialización
            loadPersonnelData();
            loadLastUpdatedTime();
        });
    </script>
</body>
</html>
