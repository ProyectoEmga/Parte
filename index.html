<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parte Dpto. Finanzas y Abastecimiento EMGA 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f4f8; /* Light gray-blue, reminiscent of naval colors */
        }
        .header-armada {
            background-color: #003366; /* Dark blue, typical for naval uniforms */
            color: #ffffff;
            padding: 1.5rem;
            text-align: center;
            border-bottom: 5px solid #ffcc00; /* Gold/yellow accent, like braiding */
            position: relative; /* For absolute positioning of date */
        }
        .header-armada .last-updated {
            position: absolute;
            bottom: 0.5rem;
            right: 1rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }
        .container-armada {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-top: 2rem;
        }
        .person-row {
            display: flex;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .person-row:last-of-type {
            border-bottom: none;
        }
        .person-name {
            font-weight: bold;
            color: #003366;
            width: 180px;
            flex-shrink: 0;
        }
        .select-group {
            flex-grow: 1;
        }
        .select-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.375rem;
            background-color: #ffffff;
            color: #4a5568;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3e%3cpath d='M7 7l3-3 3 3m0 6l-3 3-3-3' stroke='%234A5568' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em;
            accent-color: #003366;
        }
        .summary-box {
            background-color: #e6f0f9;
            border: 1px solid #b3d1f1;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
            text-align: center;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dotted #cce0f5;
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .summary-item span:first-child {
            font-weight: bold;
            color: #003366;
        }
        .add-person-section {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .add-person-section input {
            flex-grow: 1;
            padding: 0.5rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.375rem;
        }
        .button-armada {
            background-color: #004080;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.375rem;
            font-weight: bold;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .button-armada:hover {
            background-color: #0056b3;
        }
        .remove-btn {
            background-color: #dc3545;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            margin-left: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .remove-btn:hover {
            background-color: #c82333;
        }

        /* Styles specifically for PDF content - will be rendered in the hidden div */
        #pdf-render-content {
            display: none; /* Hide this div from the main page view */
            width: 210mm; /* A4 width */
            min-height: 297mm; /* A4 height */
            padding: 20mm;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
            color: #333;
            background-color: #fff;
        }
        #pdf-render-content .pdf-header {
            text-align: center;
            margin-bottom: 25px;
        }
        #pdf-render-content .pdf-header h1 {
            font-size: 26px; /* Larger for PDF title */
            color: #003366;
            margin-bottom: 8px;
            font-weight: bold;
        }
        #pdf-render-content .pdf-header p {
            font-size: 13px;
            color: #555;
        }
        #pdf-render-content .pdf-section-title {
            font-size: 20px; /* Larger for section titles */
            color: #003366;
            margin-top: 25px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
            padding-bottom: 5px;
        }
        #pdf-render-content .pdf-summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* Two columns for summary items */
            gap: 10px 20px; /* Row and column gap */
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            padding: 15px 20px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        #pdf-render-content .pdf-summary-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 14px;
            border-bottom: 1px dotted #eee;
        }
        #pdf-render-content .pdf-summary-item:nth-last-child(-n + 2) {
            border-bottom: none;
        }
        #pdf-render-content .pdf-summary-item span:first-child {
            font-weight: bold;
            color: #004080;
        }
        #pdf-render-content .pdf-personnel-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #pdf-render-content .pdf-personnel-list li {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            line-height: 1.4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #pdf-render-content .pdf-personnel-list li:last-child {
            border-bottom: none;
        }
        #pdf-render-content .pdf-personnel-list .person-name-pdf {
            font-weight: bold;
            color: #333;
            flex-grow: 1;
        }
        #pdf-render-content .pdf-personnel-list .person-status-pdf {
            font-weight: normal;
            color: #004080;
            text-align: right;
            width: 120px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">
    <header class="header-armada w-full">
        <h1 class="text-3xl font-bold">Parte Dpto. Finanzas y Abastecimiento EMGA 2025</h1>
        <div class="last-updated" id="last-updated"></div>
    </header>

    <div class="container-armada w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 mt-8 mb-8">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Estado del Personal</h2>

        <form id="personnelForm">
            </form>

        <div class="add-person-section">
            <input type="text" id="new-person-name" placeholder="Ingrese nuevo nombre de persona">
            <button type="button" id="add-person-btn" class="button-armada">Agregar Persona</button>
        </div>

        <div class="summary-box">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Recuento de Personal</h3>
            <div id="summary-display">
                <div class="summary-item"><span>Fuerza Efectiva:</span> <span id="effective-force-count">0</span></div>
                <div class="summary-item"><span>Alto mando:</span> <span id="altomando-count">0</span></div>
                <div class="summary-item"><span>A bordo:</span> <span id="abordo-count">0</span></div>
                <div class="summary-item"><span>En trabajos:</span> <span id="trabajos-count">0</span></div>
                <div class="summary-item"><span>En comisi√≥n:</span> <span id="comision-count">0</span></div>
                <div class="summary-item"><span>De baja:</span> <span id="baja-count">0</span></div>
                <div class="summary-item"><span>Con permiso:</span> <span id="permiso-count">0</span></div>
            </div>
        </div>
        <div class="text-center mt-6">
            <button type="button" id="generate-pdf-btn" class="button-armada">Generar PDF del Parte</button>
        </div>
    </div>

    <div id="pdf-render-content"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('personnelForm');
            const addPersonBtn = document.getElementById('add-person-btn');
            const newPersonNameInput = document.getElementById('new-person-name');
            const lastUpdatedElement = document.getElementById('last-updated');
            const generatePdfBtn = document.getElementById('generate-pdf-btn');
            const pdfRenderContentDiv = document.getElementById('pdf-render-content'); // Get the hidden div

            const personnelDataKey = 'personnelDataEmga2025';
            const lastUpdatedKey = 'lastUpdatedEmga2025';

            let personnel = [];

            const initialPersonnelNames = [
                'T1 ANDR√âS VARAS',
                'PAC RA√öL D√çAZ',
                'SO GERM√ÅN CASTRO',
                'SO JUAN MU√ëOZ',
                'S1 CARLOS ALARC√ìN',
                'S1 JORGE ESPINOZA',
                'S1 CARLOS JIM√âNEZ',
                'S2 GABRIEL CLAVER√çA',
                'C1 JONATAN MORAGAtoal',
                'C1 SAMI DONOSO',
                'TT PEDRO VERDUGO'
            ];

            const categories = [
                { value: 'alto mando', text: 'Alto mando' },
                { value: 'a bordo', text: 'A bordo' },
                { value: 'en trabajos', text: 'En trabajos' },
                { value: 'en comisi√≥n', text: 'En comisi√≥n' },
                { value: 'de baja', text: 'De baja' },
                { value: 'con permiso', text: 'Con permiso' }
            ];

            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            }

            function savePersonnelData() {
                localStorage.setItem(personnelDataKey, JSON.stringify(personnel));
                updateLastUpdatedTime();
            }

            function loadPersonnelData() {
                const storedData = localStorage.getItem(personnelDataKey);
                if (storedData) {
                    const loadedPersonnel = JSON.parse(storedData);
                    const loadedPersonnelMap = new Map(loadedPersonnel.map(p => [p.name, p]));

                    personnel = [];
                    initialPersonnelNames.forEach(name => {
                        if (loadedPersonnelMap.has(name)) {
                            personnel.push(loadedPersonnelMap.get(name));
                            loadedPersonnelMap.delete(name);
                        } else {
                            personnel.push({ id: generateId(), name: name, status: '' });
                        }
                    });

                    loadedPersonnelMap.forEach(p => personnel.push(p));

                } else {
                    personnel = initialPersonnelNames.map(name => ({
                        id: generateId(),
                        name: name,
                        status: ''
                    }));
                }
                renderPersonnelList();
            }

            function updateLastUpdatedTime() {
                const now = new Date();
                const options = {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZoneName: 'short',
                    hour12: false
                };
                const formattedDate = new Intl.DateTimeFormat('es-CL', {
                    ...options,
                    timeZone: 'America/Santiago'
                }).format(now);
                lastUpdatedElement.textContent = `√öltima actualizaci√≥n: ${formattedDate}`;
                localStorage.setItem(lastUpdatedKey, formattedDate);
            }

            function loadLastUpdatedTime() {
                const storedTime = localStorage.getItem(lastUpdatedKey);
                if (storedTime) {
                    lastUpdatedElement.textContent = `√öltima actualizaci√≥n: ${storedTime}`;
                } else {
                    lastUpdatedElement.textContent = '√öltima actualizaci√≥n: Nunca';
                }
            }

            function createPersonRow(person) {
                const row = document.createElement('div');
                row.className = 'person-row';
                row.id = `person-${person.id}`;

                row.innerHTML = `
                    <div class="person-name">${person.name}</div>
                    <div class="select-group">
                        <select id="status-${person.id}" name="status-${person.id}" class="person-status-select">
                            <option value="">Seleccione estado</option>
                            ${categories.map(cat => `<option value="${cat.value}" ${person.status === cat.value ? 'selected' : ''}>${cat.text}</option>`).join('')}
                        </select>
                    </div>
                    <button type="button" class="remove-btn" data-id="${person.id}">Eliminar</button>
                `;

                const selectElement = row.querySelector(`#status-${person.id}`);
                selectElement.addEventListener('change', (e) => {
                    person.status = e.target.value;
                    savePersonnelData();
                    updateSummary();
                });

                const removeBtn = row.querySelector('.remove-btn');
                removeBtn.addEventListener('click', () => {
                    removePerson(person.id);
                });

                return row;
            }

            function renderPersonnelList() {
                form.innerHTML = '';
                personnel.forEach(person => {
                    form.appendChild(createPersonRow(person));
                });
                updateSummary();
            }

            function addPerson() {
                const name = newPersonNameInput.value.trim();
                if (name) {
                    if (personnel.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                        alert('Esta persona ya existe en la lista.');
                        return;
                    }

                    const newPerson = {
                        id: generateId(),
                        name: name,
                        status: ''
                    };
                    personnel.push(newPerson);
                    newPersonNameInput.value = '';
                    savePersonnelData();
                    renderPersonnelList();
                } else {
                    alert('Por favor, ingrese un nombre para la persona.');
                }
            }

            function removePerson(idToRemove) {
                if (confirm('¬øEst√° seguro de que desea eliminar a esta persona?')) {
                    personnel = personnel.filter(person => person.id !== idToRemove);
                    savePersonnelData();
                    renderPersonnelList();
                }
            }

            // --- Summary Update (for displayed HTML) ---
            function updateSummary() {
                const counts = {
                    'effectiveForce': personnel.length,
                    'alto mando': 0,
                    'a bordo': 0,
                    'en trabajos': 0,
                    'en comisi√≥n': 0,
                    'de baja': 0,
                    'con permiso': 0
                };

                personnel.forEach(person => {
                    if (categories.some(cat => cat.value === person.status)) {
                        counts[person.status]++;
                    }
                });

                document.getElementById('effective-force-count').textContent = counts.effectiveForce;
                document.getElementById('altomando-count').textContent = counts['alto mando'];
                document.getElementById('abordo-count').textContent = counts['a bordo'];
                document.getElementById('trabajos-count').textContent = counts['en trabajos'];
                document.getElementById('comision-count').textContent = counts['en comisi√≥n'];
                document.getElementById('baja-count').textContent = counts['de baja'];
                document.getElementById('permiso-count').textContent = counts['con permiso'];
            }

            // --- PDF Generation ---
            generatePdfBtn.addEventListener('click', () => {
                const currentDateTime = new Date();
                const options = {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false,
                    timeZone: 'America/Santiago'
                };
                const formattedDate = new Intl.DateTimeFormat('es-CL', options).format(currentDateTime);

                // --- Build PDF content in the hidden div ---
                let pdfHtml = `
                    <div class="pdf-header">
                        <h1>Parte Dpto. Finanzas y Abastecimiento EMGA 2025</h1>
                        <p>Fecha de Generaci√≥n: ${formattedDate}</p>
                    </div>
                `;

                // Add Summary Section
                const summaryCounts = {
                    'Fuerza Efectiva': personnel.length,
                    'Alto mando': 0,
                    'A bordo': 0,
                    'En trabajos': 0,
                    'En comisi√≥n': 0,
                    'De baja': 0,
                    'Con permiso': 0
                };
                personnel.forEach(person => {
                    if (categories.some(cat => cat.value === person.status)) {
                        const categoryName = categories.find(cat => cat.value === person.status).text;
                        summaryCounts[categoryName]++;
                    }
                });

                pdfHtml += `<h2 class="pdf-section-title">Recuento de Personal</h2>`;
                pdfHtml += `<div class="pdf-summary-grid">`;
                for (const [key, value] of Object.entries(summaryCounts)) {
                    pdfHtml += `<div class="pdf-summary-item"><span>${key}:</span> <span>${value}</span></div>`;
                }
                pdfHtml += `</div>`;

                // Add Detail Section
                pdfHtml += `<h2 class="pdf-section-title">Detalle del Personal</h2>`;
                pdfHtml += `<ul class="pdf-personnel-list">`;
                const sortedPersonnel = [...personnel].sort((a, b) => {
                    const statusOrder = categories.map(c => c.value);
                    const statusA = statusOrder.indexOf(a.status);
                    const statusB = statusOrder.indexOf(b.status);

                    if (statusA !== statusB) {
                        return statusA - statusB;
                    }
                    return a.name.localeCompare(b.name);
                });
                sortedPersonnel.forEach(person => {
                    const statusText = categories.find(cat => cat.value === person.status)?.text || 'Sin asignar';
                    pdfHtml += `<li><span class="person-name-pdf">${person.name}</span> <span class="person-status-pdf">${statusText}</span></li>`;
                });
                pdfHtml += `</ul>`;

                // Set the innerHTML of the hidden div
                pdfRenderContentDiv.innerHTML = pdfHtml;

                // PDF Options
                const pdfOptions = {
                    margin: 10,
                    filename: `Parte_Dpto_Finanzas_EMGA_2025_${currentDateTime.getFullYear()}${(currentDateTime.getMonth()+1).toString().padStart(2, '0')}${currentDateTime.getDate().toString().padStart(2, '0')}_${currentDateTime.getHours().toString().padStart(2, '0')}${currentDateTime.getMinutes().toString().padStart(2, '0')}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 3, logging: true, dpi: 300, letterRendering: true, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                // Use html2pdf with the hidden div as the source
                html2pdf().from(pdfRenderContentDiv).set(pdfOptions).save();
            });

            // --- Initialization ---
            loadPersonnelData();
            loadLastUpdatedTime();

            addPersonBtn.addEventListener('click', addPerson);
            newPersonNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addPerson();
                }
            });
        });
    </script>
</body>
</html>
